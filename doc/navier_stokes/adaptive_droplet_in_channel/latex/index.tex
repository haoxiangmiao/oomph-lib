In this tutorial we demonstrate another adaptive solution of free surface problems on unstructured meshes, using the example of a droplet propagating along a straight channel. The problem is extremely similar to \href{../../adaptive_bubble_in_channel/html/index.html}{\tt the propagation of a bubble in a channel tutorial }. Thus, we shall only discuss the differences from that tutorial. The key physical difference is that instead of the uniform pressure state in an inviscid bubble, the droplet consists of a viscous fluid that can support internal stress variations.



 

\hypertarget{index_example}{}\section{The example problem}\label{index_example}
We illustrate the solution of the unsteady 2D Navier-\/\+Stokes equations by considering the propagation of a single droplet along a straight channel as shown in the sketch below. The non-\/dimensionalisation is the same as in the \href{../../adaptive_bubble_in_channel/html/index.html}{\tt bubble tutorial, } and we choose the viscosity and density of the surrounding liquid to be the reference values.

 
\begin{DoxyImage}
\includegraphics[width=0.9\textwidth]{problem}
\doxyfigcaption{The problem setup. }
\end{DoxyImage}


The governing equations and boundary conditions are the same as those in the \href{../../adaptive_bubble_in_channel/html/index.html}{\tt bubble tutorial. } The only difference is that the Navier--Stokes equations must also be solved within the droplet. In fact, this is a two-\/fluid problem, a class of problems that is first introduced in \href{../../two_layer_interface/html/index.html}{\tt another tutorial. }





The constraint that the droplet volume remains constant must be enforced explicitly in the static case, as in the bubble problem. In the time-\/simulations, however, a constant drop volume is implicitly enforced by the continuity equation. For the bubble, the continuity equation is not solved within the interior, which is why the volume constraint must always be explicitly enforced in that case.



 

\hypertarget{index_implementation}{}\section{Implementation}\label{index_implementation}
We use the same method as in the \href{../../adaptive_bubble_in_channel/html/index.html}{\tt bubble problem, } an A\+L\+E-\/based finite-\/element method with \href{../../single_layer_free_surface/html/index.html#kinematic_condition_implementation}{\tt a pseudo-\/elastic node-\/update procedure}. In this case, there is a pressure jump across the interface between the fluids, which means that we use triangular Crouzeix--Raviart elements rather than the continuous-\/pressure Taylor--Hood elements. Again, we impose the kinematic and dynamic boundary conditions with {\ttfamily Face\+Elements}. The volume constraint for the static problem is also imposed in a similar way\+: we attach {\ttfamily Line\+Volume\+Constraint\+Bounding\+Solid\+Elements} to the droplet surface and create an additional {\ttfamily Volume\+Constraint\+Element}. Here, a pressure degree of freedom within the droplet is hijacked, see \href{../../static_two_layer/html/index.html}{\tt another tutorial, } to be used as the unknown associated with the volume constraint. Once the static initial problem has been solved, the \char`\"{}volume constraint\char`\"{} elements are deleted and the pressure degree of freedom is unhijacked.



 

\hypertarget{index_results}{}\section{Results}\label{index_results}
We perform the simulation in a two-\/stage procedure. We start by performing a steady solve with the inflow switched off. This deforms the droplet into its steady state (approximately) circular configuration with the required volume. The actual time-\/dependent simulation is then performed with an impulsive start from this configuration.

The figure below shows the location of the droplet and mesh (upper figure) and a contour plot of the pressure distribution with overlaid velocity vectors of the difference between the background Poiseuille flow and the velocity field (lower figure). The figure is a snapshot for the parameters $ Re = ReSt = 0.0 $, $ Ca = 10.0 $ and a droplet that is ten times as viscous as the surrounding liquid.

 
\begin{DoxyImage}
\includegraphics[width=0.7\textwidth]{drop_snapshot}
\doxyfigcaption{Snapshot of the flow field (velocity vectors and pressure contours) for a propagating droplet. }
\end{DoxyImage}




 

\hypertarget{index_parameters}{}\section{Global parameters}\label{index_parameters}
The namespace containing the dimensionless parameters contains an additional viscosity ratio parameter, compared to that in the \href{../../adaptive_bubble_in_channel/html/index.html}{\tt bubble problem }.

 
\begin{DoxyCodeInclude}
  \textcolor{comment}{/// Viscosity ratio of the droplet to the surrounding fluid}
  \textcolor{keywordtype}{double} \hyperlink{namespaceProblem__Parameter_afdb95f68bd3c77e4c12001a29bd26e31}{Viscosity\_ratio} = 10.0;

\end{DoxyCodeInclude}




 

\hypertarget{index_main}{}\section{The driver code}\label{index_main}
The first difference from the bubble problem is that the steady solver does not converge when $ Ca = 10 $. Instead, we start with $ Ca = 1 $, solve the steady problem, set $ Ca=10$ and then resolve.


\begin{DoxyCodeInclude}
 problem.steady\_newton\_solve(1); 

 \textcolor{comment}{//Set the Capillary number to 10 and resolve}
 \hyperlink{namespaceProblem__Parameter_af6194d2571881779c678fbabc1503d47}{Problem\_Parameter::Ca} = 10.0;
 problem.steady\_newton\_solve();

\end{DoxyCodeInclude}


After documenting the solution, we remove the (explicit) volume constraint and then the remainder of the code is identical to that in the \href{../../adaptive_bubble_in_channel/html/index.html}{\tt bubble tutorial. }


\begin{DoxyCodeInclude}
 \textcolor{comment}{// Switch off volume constraint}
 problem.remove\_volume\_constraint();

\end{DoxyCodeInclude}




 

\hypertarget{index_problem}{}\section{The problem class}\label{index_problem}
Other than trivial name changes from \char`\"{}bubble\char`\"{} to \char`\"{}drop\char`\"{}, there are a few significant changes between this problem and that in the \href{../../adaptive_bubble_in_channel/html/index.html}{\tt bubble tutorial. } There is an additional boolean {\ttfamily Use\+\_\+volume\+\_\+constraint} and an additional function {\ttfamily remove\+\_\+volume\+\_\+constraint()}, which are used to manage the switch from the explicit enforcement of the volume constraint in the static case to the implicit enforcement in the time simulations. The other key difference is that we use {\ttfamily Triangle\textquotesingle{}s} \href{../../../meshes/mesh_from_inline_triangle_internal_boundaries/html/index.html#def_extra_regions}{\tt region attributes } to distinguish the elements inside the droplet from those outside. The default behaviour is that all elements are in region 0, but we label those element within the drop as region 1.



 

\hypertarget{index_constructor}{}\section{The problem constructor}\label{index_constructor}
The construction of the mesh proceeds in exactly the same way as in \href{../../adaptive_bubble_in_channel/html/index.html}{\tt bubble tutorial, } except that we add a region tag \char`\"{}1\char`\"{} to label the elements within the droplet (so we specify a coordinate within the drop) and we must tell {\ttfamily Triangle} to use the assigned attributes.  
\begin{DoxyCodeInclude}
 \textcolor{comment}{// Define the region}
 triangle\_mesh\_parameters.add\_region\_coordinates(1, drop\_center);

\end{DoxyCodeInclude}
 The remainder of the constructor is the same as the other tutorial.



 

\hypertarget{index_problem_setup}{}\section{Problem setup}\label{index_problem_setup}
When the bulk elements are made fully functional, we add the pointer to the viscosity ratio to all elements in the drop (region 1).


\begin{DoxyCodeInclude}
   \textcolor{comment}{//For the elements within the droplet (region 1),}
   \textcolor{comment}{//set the viscosity ratio}
   n\_element = Fluid\_mesh\_pt->nregion\_element(1);
   \textcolor{keywordflow}{for}(\textcolor{keywordtype}{unsigned} e=0;e<n\_element;e++)
    \{
     \textcolor{comment}{// Upcast from GeneralisedElement to the present element}
     ELEMENT* el\_pt = 
      \textcolor{keyword}{dynamic\_cast<}ELEMENT*\textcolor{keyword}{>}(Fluid\_mesh\_pt->region\_element\_pt(1,e));
     
     el\_pt->viscosity\_ratio\_pt() = &\hyperlink{namespaceProblem__Parameter_afdb95f68bd3c77e4c12001a29bd26e31}{Problem\_Parameter::Viscosity\_ratio};
    \}

\end{DoxyCodeInclude}




 

\hypertarget{index_face_elements}{}\section{Generation of face elements}\label{index_face_elements}
As usual we impose the kinematic and dynamic boundary condition at the interface by attaching {\ttfamily Face\+Elements} to the relevant boundaries of the bulk elements. However, we must be careful to add only a {\bfseries single} layer of elements. If we use the standard \char`\"{}boundary element\char`\"{} functions then we will be creating face elements on both sides of the internal boundary. Instead, we use the elements adjacent to the boundary within region 0, which ensures that only a single layer of interface elements are added.

 
\begin{DoxyCodeInclude}
\textcolor{comment}{//============start\_of\_create\_free\_surface\_elements===============}
\textcolor{comment}{/// Create elements that impose the kinematic and dynamic bcs}
\textcolor{comment}{}\textcolor{comment}{/// for the pseudo-solid fluid mesh}
\textcolor{comment}{}\textcolor{comment}{//=======================================================================}
\textcolor{keyword}{template}<\textcolor{keyword}{class} ELEMENT>
\textcolor{keywordtype}{void} \hyperlink{classDropInChannelProblem_a73b989e3bedbd3630f576b0dba0f724f}{DropInChannelProblem<ELEMENT>::create\_free\_surface\_elements}
      ()
\{ 

 \textcolor{comment}{//Loop over the free surface boundaries}
 \textcolor{keywordtype}{unsigned} nb=Fluid\_mesh\_pt->nboundary();
 \textcolor{keywordflow}{for}(\textcolor{keywordtype}{unsigned} b=First\_drop\_boundary\_id;b<nb;b++)
  \{
   \textcolor{comment}{// Note: region is important}
   \textcolor{comment}{// How many bulk fluid elements are adjacent to boundary b in region 0?}
   \textcolor{keywordtype}{unsigned} n\_element = Fluid\_mesh\_pt->nboundary\_element\_in\_region(b,0);
   
   \textcolor{comment}{// Loop over the bulk fluid elements adjacent to boundary b?}
   \textcolor{keywordflow}{for}(\textcolor{keywordtype}{unsigned} e=0;e<n\_element;e++)
    \{
     \textcolor{comment}{// Get pointer to the bulk fluid element that is }
     \textcolor{comment}{// adjacent to boundary b in region 0}
     ELEMENT* bulk\_elem\_pt = \textcolor{keyword}{dynamic\_cast<}ELEMENT*\textcolor{keyword}{>}(
      Fluid\_mesh\_pt->boundary\_element\_in\_region\_pt(b,0,e));
     
     \textcolor{comment}{//Find the index of the face of element e along boundary b in region 0}
     \textcolor{keywordtype}{int} face\_index = Fluid\_mesh\_pt->face\_index\_at\_boundary\_in\_region(b,0,e);
     
     \textcolor{comment}{// Create new element}
     ElasticLineFluidInterfaceElement<ELEMENT>* el\_pt =
      \textcolor{keyword}{new} ElasticLineFluidInterfaceElement<ELEMENT>(
       bulk\_elem\_pt,face\_index);   
     
     \textcolor{comment}{// Add it to the mesh}
     Free\_surface\_mesh\_pt->add\_element\_pt(el\_pt);
     
     \textcolor{comment}{//Add the appropriate boundary number}
     el\_pt->set\_boundary\_number\_in\_bulk\_mesh(b);
     
     \textcolor{comment}{//Specify the capillary number}
     el\_pt->ca\_pt() = &\hyperlink{namespaceProblem__Parameter_af6194d2571881779c678fbabc1503d47}{Problem\_Parameter::Ca};
    \}
  \}
\}
\textcolor{comment}{// end of create\_free\_surface\_elements}

\end{DoxyCodeInclude}


The volume constraint elements are only created if the boolean flag {\ttfamily Use\+\_\+volume\+\_\+constraint} is true (the default on construction of the problem). We hijack the pressure degree of freedom associated with the first element in region 1 and then the construction of the elements again uses the regions to ensure that a single layer of elements is created.


\begin{DoxyCodeInclude}
\textcolor{comment}{//============start\_of\_create\_volume\_constraint\_elements=================}
\textcolor{comment}{/// Create elements that impose volume constraint on the drop}
\textcolor{comment}{}\textcolor{comment}{//=======================================================================}
\textcolor{keyword}{template}<\textcolor{keyword}{class} ELEMENT>
\textcolor{keywordtype}{void} \hyperlink{classDropInChannelProblem_a53b96cd50b4e6c9bee294b8fb7dd51bd}{DropInChannelProblem<ELEMENT>::create\_volume\_constraint\_elements}
      ()
\{ 

 \textcolor{comment}{// Do we need it?}
 \textcolor{keywordflow}{if} (!Use\_volume\_constraint) \textcolor{keywordflow}{return};

 \textcolor{comment}{// Store pointer to element whose pressure we're trading/hi-jacking:}
 \textcolor{comment}{// Element 0 in region 1}
 Hijacked\_element\_pt= \textcolor{keyword}{dynamic\_cast<}ELEMENT*\textcolor{keyword}{>}(
  Fluid\_mesh\_pt->region\_element\_pt(1,0));

 \textcolor{comment}{// Set the global pressure data by hijacking one of the pressure values}
 \textcolor{comment}{// from inside the droplet}
 \textcolor{keywordtype}{unsigned} index\_of\_traded\_pressure=0;
 Drop\_pressure\_data\_pt=Hijacked\_element\_pt->
  hijack\_internal\_value(0,index\_of\_traded\_pressure);
 
 \textcolor{comment}{// Build volume constraint element -- pass traded pressure to it}
 Vol\_constraint\_el\_pt= 
  \textcolor{keyword}{new} VolumeConstraintElement(&\hyperlink{namespaceProblem__Parameter_aad8e0a2d1ec39a8dd7357a43bcc5f20e}{Problem\_Parameter::Volume},
                              Drop\_pressure\_data\_pt,
                              index\_of\_traded\_pressure);

  \textcolor{comment}{//Provide a reasonable initial guess for drop pressure (hydrostatics):}
 Drop\_pressure\_data\_pt->set\_value(index\_of\_traded\_pressure,
                                    Initial\_value\_for\_drop\_pressure);

 \textcolor{comment}{// Add volume constraint element to the mesh}
 Volume\_constraint\_mesh\_pt->add\_element\_pt(Vol\_constraint\_el\_pt);
 
 \textcolor{comment}{//Loop over the free surface boundaries}
 \textcolor{keywordtype}{unsigned} nb=Fluid\_mesh\_pt->nboundary();
 \textcolor{keywordflow}{for}(\textcolor{keywordtype}{unsigned} b=First\_drop\_boundary\_id;b<nb;b++)
  \{
   \textcolor{comment}{// Note region is important}
   \textcolor{comment}{// How many bulk fluid elements are adjacent to boundary b in region 0?}
   \textcolor{keywordtype}{unsigned} n\_element = Fluid\_mesh\_pt->nboundary\_element\_in\_region(b,0);
   
   \textcolor{comment}{// Loop over the bulk fluid elements adjacent to boundary b?}
   \textcolor{keywordflow}{for}(\textcolor{keywordtype}{unsigned} e=0;e<n\_element;e++)
    \{
     \textcolor{comment}{// Get pointer to the bulk fluid element that is }
     \textcolor{comment}{// adjacent to boundary b in region 0?}
     ELEMENT* bulk\_elem\_pt = \textcolor{keyword}{dynamic\_cast<}ELEMENT*\textcolor{keyword}{>}(
      Fluid\_mesh\_pt->boundary\_element\_in\_region\_pt(b,0,e));
     
     \textcolor{comment}{//Find the index of the face of element e along boundary b in region 0}
     \textcolor{keywordtype}{int} face\_index = Fluid\_mesh\_pt->face\_index\_at\_boundary\_in\_region(b,0,e);
     
     \textcolor{comment}{// Create new element}
     ElasticLineVolumeConstraintBoundingElement<ELEMENT>* el\_pt =
      \textcolor{keyword}{new} ElasticLineVolumeConstraintBoundingElement<ELEMENT>(
       bulk\_elem\_pt,face\_index);   
     
     \textcolor{comment}{//Set the "master" volume constraint element}
     el\_pt->set\_volume\_constraint\_element(Vol\_constraint\_el\_pt);
     
     \textcolor{comment}{// Add it to the mesh}
     Volume\_constraint\_mesh\_pt->add\_element\_pt(el\_pt);     
    \} 
  \}
\}
\textcolor{comment}{// end of create\_volume\_constraint\_elements}

\end{DoxyCodeInclude}




 

\hypertarget{index_remove}{}\section{Removal of the volume constraint}\label{index_remove}
The function {\ttfamily remove\+\_\+volume\+\_\+constraint()}, resets the boolean flag to false, clears the hijacked data, deletes the volume constraint elements and mesh and then removes the volume constraint mesh from the problem\textquotesingle{}s list of sub meshes, before reassigning the equation numbers.

 
\begin{DoxyCodeInclude}
 \textcolor{comment}{/// Change the boundary conditions to remove the volume constraint}
 \textcolor{keywordtype}{void} remove\_volume\_constraint()
  \{
   \textcolor{comment}{// Ignore all volume constraint stuff from here onwards}
   Use\_volume\_constraint=\textcolor{keyword}{false};

   \textcolor{comment}{//Unhijack the data in the internal element}
   Hijacked\_element\_pt->unhijack\_all\_data();

   \textcolor{comment}{//Delete the volume constraint elements}
   delete\_volume\_constraint\_elements();

   \textcolor{comment}{// Internal pressure is gone -- null it out}
   Drop\_pressure\_data\_pt=0;

   \textcolor{comment}{// Kill the mesh too}
   \textcolor{keyword}{delete} Volume\_constraint\_mesh\_pt;
   Volume\_constraint\_mesh\_pt=0;

   \textcolor{comment}{//Remove the sub meshes}
   this->flush\_sub\_meshes();

    \textcolor{comment}{// Add Fluid\_mesh\_pt sub meshes}
   this->add\_sub\_mesh(Fluid\_mesh\_pt);

    \textcolor{comment}{// Add Free\_surface sub meshes}
   this->add\_sub\_mesh(this->Free\_surface\_mesh\_pt);

   \textcolor{comment}{//Rebuild the global mesh}
   this->rebuild\_global\_mesh();
   
   \textcolor{comment}{//Renumber the equations}
   std::cout << \textcolor{stringliteral}{"Removed volume constraint to obtain "}
             << this->assign\_eqn\_numbers() << \textcolor{stringliteral}{" new equation numbers\(\backslash\)n"};
  \}

\end{DoxyCodeInclude}




 

\hypertarget{index_comments}{}\section{Comments and Exercises}\label{index_comments}
The computation of the initial static solution means that we must still include the calls to the {\ttfamily create\+\_\+volume\+\_\+constraint\+\_\+elements()} and {\ttfamily delete\+\_\+volume\+\_\+constraint\+\_\+elements()} in {\ttfamily actions\+\_\+before\+\_\+adapt()} and {\ttfamily actions\+\_\+after\+\_\+adapt()}. We have chosen to have the functions return immediately if the volume constraint is not being enforced, rather than using {\ttfamily if} blocks within the {\ttfamily actions\+\_\+before/after\+\_\+adapt}() functions.



\hypertarget{index_exercises}{}\subsection{Exercises}\label{index_exercises}

\begin{DoxyEnumerate}
\item Explore what happens as the viscosity ratio is varied. Are the results as you expect? Does the solution tend to a steadily propagating state? Does the solution approach the bubble solution as this viscosity ratio tends to zero? (Is this a sensible limit to take?) ~\newline
~\newline

\item How could you modify the code to compute the steadily-\/propagating solutions directly, rather than using time simulation? ~\newline
~\newline

\end{DoxyEnumerate}

 

\hypertarget{index_sources}{}\section{Source files for this tutorial}\label{index_sources}

\begin{DoxyItemize}
\item The source files for this tutorial are located in the directory\+:~\newline
~\newline
 \begin{center} \href{../../../../demo_drivers/navier_stokes/unstructured_adaptive_fs/}{\tt demo\+\_\+drivers/navier\+\_\+stokes/unstructured\+\_\+adaptive\+\_\+fs/ } \end{center} ~\newline

\item The driver code is\+: ~\newline
~\newline
 \begin{center} \href{../../../../demo_drivers/navier_stokes/unstructured_adaptive_fs/adaptive_drop_in_channel.cc}{\tt demo\+\_\+drivers/navier\+\_\+stokes/unstructured\+\_\+adaptive\+\_\+fs/adaptive\+\_\+drop\+\_\+in\+\_\+channel.\+cc} \end{center}  .
\end{DoxyItemize}



 

 \hypertarget{index_pdf}{}\section{P\+D\+F file}\label{index_pdf}
A \href{../latex/refman.pdf}{\tt pdf version} of this document is available. \end{document}
