In this example we consider the flow in a 2D channel which is partially obstructed by an oscillating leaflet. We consider the case where the motion of the leaflet is prescribed -- this is a \char`\"{}warm-\/up exercise\char`\"{} for the \href{../../../interaction/fsi_channel_with_leaflet/html/index.html}{\tt corresponding F\+SI problem } in which the leaflet is an elastic structure.



 

\hypertarget{index_the_problem}{}\section{The Problem}\label{index_the_problem}
The figure below shows a sketch of the problem\+: A 2D channel of height $ H^*_{tot}$ and length $ L^*_{left} + L^*_{right} $ is partially occluded by a (zero-\/thickness) leaflet of height $ H^*_{leaflet} $. The leaflet is parametrised by a Lagrangian coordinate $ \xi^* $ so that the position vector to a material point on the leaflet is given by $ {\bf R}^*_w(\xi^*,t^*) $, and we assume that the leaflet performs time-\/periodic oscillations with period $ T^*. $ Steady Poiseuille flow with average velocity $ U^* $ is imposed at the left end of the channel while we assume that the outflow is parallel and axially traction-\/free.

 
\begin{DoxyImage}
\includegraphics[width=0.75\textwidth]{channel_with_leaflet_dim}
\doxyfigcaption{Sketch of the problem in dimensional }
\end{DoxyImage}


We non-\/dimensionalise all length and coordinates on the channel width, $ H^*_{tot} $ , time on the natural timescale of the flow, $ H^*_{tot}/U^* $, the velocities on the mean velocity, $ U^* $, and the pressure on the viscous scale. The problem is then governed by the non-\/dimensional Navier-\/\+Stokes equations \[ Re \left( St \frac{\partial u_i}{\partial t} + u_j \frac{\partial u_i}{\partial x_j} \right) = - \frac{\partial p}{\partial x_i} + \frac{\partial }{\partial x_j} \left[ \left( \frac{\partial u_i}{\partial x_j} + \frac{\partial u_j}{\partial x_i} \right) \right], \] where $ Re = \rho U^* H_0^* / \mu $ and $ St = 1 $, and \begin{center} \[ \frac{\partial u_i}{\partial x_i} = 0, \] \end{center}  subject to parabolic inflow \begin{center} \[ {\bf u} = 6 x_2 (1-x_2) {\bf e}_1 \] \end{center}  at the inflow cross-\/section; parallel, axially-\/traction-\/free outflow at the outlet; and no-\/slip on the stationary channel walls, $ {\bf u} = {\bf 0} $. The no-\/slip condition on the leaflet is \begin{center} \[ {\bf u} = \frac{\partial {\bf R}_w(\xi,t)}{\partial t} \] \end{center}  and the leaflet performs oscillations with non-\/dimensional period $ T = T^* U^* / H^*_{tot} $. Here is a sketch of the non-\/dimensional version of the problem\+:

 
\begin{DoxyImage}
\includegraphics[width=0.75\textwidth]{channel_with_leaflet}
\doxyfigcaption{Sketch of the problem in dimensionless variables. }
\end{DoxyImage}


An interesting feature of this problem is that even though the leaflet is assumed to have negligible thickness its presence will generate a pressure jump between its two faces. (The velocities are continuous because the no-\/slip condition imposes the same velocity on both faces.) When discretising the problem with {\ttfamily Q\+Taylor\+Hood} elements (for which the pressure varies continuously across the element boundaries), the mesh must therefore be \char`\"{}opened up\char`\"{} with a cut along the position of the leaflet. This is done in the constructor of the \href{../../../meshes/mesh_list/html/index.html#channel_with_leaflet}{\tt {\ttfamily Channel\+With\+Leaflet\+Mesh}} which forms the basis of {\ttfamily Refineable\+Algebraic\+Channel\+With\+Leaflet\+Mesh} used to discretise this problem. (See \hyperlink{index_comm_and_ex}{Further comments and exercises} for a more detailed discussion of the mesh.)



 

\hypertarget{index_results}{}\section{Results}\label{index_results}
The figure below shows a snapshot of the flow field (pressure contours and instantaneous streamlines) for a Reynolds number of $ Re=20 $ and an oscillation period of $ T=20 $, as well as the corresponding fluid mesh. Note how {\ttfamily oomph-\/lib\textquotesingle{}s} automatic mesh adaptation has refined the mesh near the tip of the leaflet where the pressure has a singularity.

 
\begin{DoxyImage}
\includegraphics[width=0.75\textwidth]{channel_with_leaflet_flow_cropped}
\doxyfigcaption{Mesh (top) and flow field (bottom). }
\end{DoxyImage}


The corresponding \href{../figures/channel_with_leaflet_flow.avi}{\tt animation} illustrates the algebraic node update strategy (implemented with an {\ttfamily Algebraic\+Mesh}, discussed in more detail in \href{../../algebraic_collapsible_channel/html/index.html}{\tt another tutorial}) and the evolution of the flow field. Note that the instantaneous streamlines intersect the (impermeable) leaflet because the leaflet is not stationary.



 

\hypertarget{index_parameters}{}\section{The global parameters}\label{index_parameters}
As usual we use a namespace to define the (single) global parameter, the Reynolds number.

 
\begin{DoxyCodeInclude}
\textcolor{comment}{//==start\_of\_global\_parameters=======================================}
\textcolor{comment}{/// Global parameters}
\textcolor{comment}{}\textcolor{comment}{//===================================================================}
\textcolor{keyword}{namespace }\hyperlink{namespaceGlobal__Physical__Variables}{Global\_Physical\_Variables}
\{
\textcolor{comment}{}
\textcolor{comment}{ /// Reynolds number}
\textcolor{comment}{} \textcolor{keywordtype}{double} \hyperlink{namespaceGlobal__Physical__Variables_ab814e627d2eb5bc50318879d19ab16b9}{Re}=20.0;

\} \textcolor{comment}{// end\_of\_namespace}

\end{DoxyCodeInclude}




 

\hypertarget{index_leaflet}{}\section{Specification of the leaflet geometry}\label{index_leaflet}
We specify the leaflet geometry and its time-\/dependent motion by representing it as a {\ttfamily Geom\+Object}. The {\ttfamily Geom\+Object} has one Lagrangian and two Eulerian coordinates, and its geometry is characterised by its length, the x-\/coordinate of its origin, $ X_0 $, and the period and amplitude of the horizontal and vertical tip deflection.

 
\begin{DoxyCodeInclude}
\textcolor{comment}{//===start\_of\_leaflet\_class===========================================}
\textcolor{comment}{/// GeomObject representing a vertical leaflet that performs}
\textcolor{comment}{}\textcolor{comment}{/// bending and stretching oscillations. }
\textcolor{comment}{}\textcolor{comment}{//====================================================================}
\textcolor{keyword}{class }\hyperlink{classLeaflet}{Leaflet} : \textcolor{keyword}{public} GeomObject
\{

\textcolor{keyword}{public}:
\textcolor{comment}{}
\textcolor{comment}{ /// \(\backslash\)short Constructor: Pass length (in Lagrangian coordinates),}
\textcolor{comment}{ /// the amplitude of the horizontal and vertical deflection of the tip,}
\textcolor{comment}{ /// the x-coordinate of the origin and the period of the oscillation.}
\textcolor{comment}{ /// Passes the number of Lagrangian and Eulerian coordinates to the}
\textcolor{comment}{ /// constructor of the GeomObject base class.}
\textcolor{comment}{} \hyperlink{classLeaflet_acb53ccf4578a9981216cf0afd4b38453}{Leaflet}(\textcolor{keyword}{const} \textcolor{keywordtype}{double}& \hyperlink{classLeaflet_a7a28827b7081107ac9e33087598ca868}{length}, \textcolor{keyword}{const} \textcolor{keywordtype}{double}& d\_x,\textcolor{keyword}{const} \textcolor{keywordtype}{double}& d\_y,
         \textcolor{keyword}{const} \textcolor{keywordtype}{double}& x\_0, \textcolor{keyword}{const} \textcolor{keywordtype}{double}& period, Time* time\_pt)
  : GeomObject(1,2), \hyperlink{classLeaflet_a64c27b796ceece358d09d137f15bbf20}{Length}(length), \hyperlink{classLeaflet_a473b6f4ef98bfba9e2c6974027ba4f4b}{D\_x}(d\_x), \hyperlink{classLeaflet_af9c75c7aeecae4b14f7ba0fb245eb8ee}{D\_y}(d\_y), \hyperlink{classLeaflet_a29a25366a0cf97ad0dd36172fdfa3d0c}{X\_0}(x\_0),
   \hyperlink{classLeaflet_a0d78b5fb3ec71009d4a9bcc79f8a85a9}{T}(period),\hyperlink{classLeaflet_ac10f13ad45456dc714ab57042861de53}{Time\_pt}(time\_pt) \{\}

\textcolor{comment}{}
\textcolor{comment}{ /// Destructor -- emtpy}
\textcolor{comment}{} \textcolor{keyword}{virtual} \hyperlink{classLeaflet_a0bbfaeec2534389b203fd2a2316db859}{~Leaflet}()\{\}
\textcolor{comment}{}
\textcolor{comment}{ /// \(\backslash\)short Position vector, r, to the point identified by  }
\textcolor{comment}{ /// its 1D Lagrangian coordinate, xi (passed as a 1D Vector) at discrete time}
\textcolor{comment}{ /// level t (t=0: present; t>0: previous).}
\textcolor{comment}{} \textcolor{keywordtype}{void} \hyperlink{classLeaflet_a5b78c2735652b6a5c08c6aa9d38b6232}{position}(\textcolor{keyword}{const} \textcolor{keywordtype}{unsigned}& t, \textcolor{keyword}{const} Vector<double>& xi, 
               Vector<double>& r)\textcolor{keyword}{ const}
\textcolor{keyword}{  }\{
    \textcolor{keyword}{using namespace }MathematicalConstants;

   \textcolor{comment}{//Position}
    r[0] =  \hyperlink{classLeaflet_a29a25366a0cf97ad0dd36172fdfa3d0c}{X\_0} + \hyperlink{classLeaflet_a473b6f4ef98bfba9e2c6974027ba4f4b}{D\_x}*xi[0]*xi[0]/\hyperlink{classLeaflet_a64c27b796ceece358d09d137f15bbf20}{Length}/\hyperlink{classLeaflet_a64c27b796ceece358d09d137f15bbf20}{Length}*sin(2.0*Pi*
      \hyperlink{classLeaflet_ac10f13ad45456dc714ab57042861de53}{Time\_pt}->time(t)/\hyperlink{classLeaflet_a0d78b5fb3ec71009d4a9bcc79f8a85a9}{T});
    r[1] = xi[0]*(1.0+\hyperlink{classLeaflet_af9c75c7aeecae4b14f7ba0fb245eb8ee}{D\_y}/\hyperlink{classLeaflet_a64c27b796ceece358d09d137f15bbf20}{Length}*0.5*(1.0-cos(4.0*Pi*\hyperlink{classLeaflet_ac10f13ad45456dc714ab57042861de53}{Time\_pt}->time(t)/
      \hyperlink{classLeaflet_a0d78b5fb3ec71009d4a9bcc79f8a85a9}{T})));
  \}
 \textcolor{comment}{}
\textcolor{comment}{ /// Steady version: Get current shape}
\textcolor{comment}{} \textcolor{keywordtype}{void} \hyperlink{classLeaflet_a5b78c2735652b6a5c08c6aa9d38b6232}{position}(\textcolor{keyword}{const} Vector<double>& xi, Vector<double>& r)\textcolor{keyword}{ const}
\textcolor{keyword}{  }\{
   \hyperlink{classLeaflet_a5b78c2735652b6a5c08c6aa9d38b6232}{position}(0,xi,r); 
  \}
\textcolor{comment}{}
\textcolor{comment}{ /// Number of geometric Data in GeomObject: None.}
\textcolor{comment}{} \textcolor{keywordtype}{unsigned} \hyperlink{classLeaflet_a91f2460718ec5a4ef32e302b8b14cdca}{ngeom\_data}()\textcolor{keyword}{ const }\{\textcolor{keywordflow}{return} 0;\}  
\textcolor{comment}{}
\textcolor{comment}{ /// Length of the leaflet}
\textcolor{comment}{} \textcolor{keywordtype}{double} \hyperlink{classLeaflet_a7a28827b7081107ac9e33087598ca868}{length}() \{ \textcolor{keywordflow}{return} \hyperlink{classLeaflet_a64c27b796ceece358d09d137f15bbf20}{Length}; \}
\textcolor{comment}{}
\textcolor{comment}{ /// Amplitude of horizontal tip displacement}
\textcolor{comment}{} \textcolor{keywordtype}{double}& \hyperlink{classLeaflet_a48e4d16790ffd9de527093eac8ff566c}{d\_x}() \{\textcolor{keywordflow}{return} \hyperlink{classLeaflet_a473b6f4ef98bfba9e2c6974027ba4f4b}{D\_x};\}
\textcolor{comment}{}
\textcolor{comment}{ /// Amplitude of vertical tip displacement}
\textcolor{comment}{} \textcolor{keywordtype}{double} \hyperlink{classLeaflet_a8ff8044a3da540c7c9d7a89790b6ee58}{d\_y}() \{\textcolor{keywordflow}{return} \hyperlink{classLeaflet_af9c75c7aeecae4b14f7ba0fb245eb8ee}{D\_y};\}
\textcolor{comment}{}
\textcolor{comment}{ /// x-coordinate of leaflet origin}
\textcolor{comment}{} \textcolor{keywordtype}{double} \hyperlink{classLeaflet_af4a819a3ba64960f4b796dc5a0d3eb5b}{x\_0}() \{\textcolor{keywordflow}{return} \hyperlink{classLeaflet_a29a25366a0cf97ad0dd36172fdfa3d0c}{X\_0};\}
 
private :
 \textcolor{comment}{}
\textcolor{comment}{ /// Length in terms of Lagrangian coordinates}
\textcolor{comment}{} \textcolor{keywordtype}{double} \hyperlink{classLeaflet_a64c27b796ceece358d09d137f15bbf20}{Length};
 \textcolor{comment}{}
\textcolor{comment}{ ///\(\backslash\)short Horizontal displacement of tip}
\textcolor{comment}{} \textcolor{keywordtype}{double} \hyperlink{classLeaflet_a473b6f4ef98bfba9e2c6974027ba4f4b}{D\_x};
 \textcolor{comment}{}
\textcolor{comment}{ ///\(\backslash\)short Vertical displacement of tip}
\textcolor{comment}{} \textcolor{keywordtype}{double} \hyperlink{classLeaflet_af9c75c7aeecae4b14f7ba0fb245eb8ee}{D\_y};
 \textcolor{comment}{}
\textcolor{comment}{///\(\backslash\)short Origin}
\textcolor{comment}{} \textcolor{keywordtype}{double} \hyperlink{classLeaflet_a29a25366a0cf97ad0dd36172fdfa3d0c}{X\_0};
 \textcolor{comment}{}
\textcolor{comment}{ ///Period of the oscillations}
\textcolor{comment}{} \textcolor{keywordtype}{double} \hyperlink{classLeaflet_a0d78b5fb3ec71009d4a9bcc79f8a85a9}{T};
\textcolor{comment}{}
\textcolor{comment}{ ///Pointer to the global time object}
\textcolor{comment}{} Time* \hyperlink{classLeaflet_ac10f13ad45456dc714ab57042861de53}{Time\_pt};

\}; \textcolor{comment}{//end\_of\_the\_GeomObject}

\end{DoxyCodeInclude}




 

 \hypertarget{index_main}{}\section{The driver code}\label{index_main}
We store the command line arguments, create a {\ttfamily Doc\+Info} object, and assign the parameters that specify the domain and the leaflet geometry\+:

 
\begin{DoxyCodeInclude}
\textcolor{comment}{//======start\_of\_main==================================================}
\textcolor{comment}{/// Driver code -- pass a command line argument if you want to run}
\textcolor{comment}{}\textcolor{comment}{/// the code in validation mode where it only performs a few steps}
\textcolor{comment}{}\textcolor{comment}{//=====================================================================}
\textcolor{keywordtype}{int} \hyperlink{channel__with__leaflet_8cc_a0ddf1224851353fc92bfbff6f499fa97}{main}(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char}* argv[])
\{

 \textcolor{comment}{// Store command line arguments}
 CommandLineArgs::setup(argc,argv);
 
 \textcolor{comment}{// Set up doc info}
 DocInfo doc\_info; 
 doc\_info.set\_directory(\textcolor{stringliteral}{"RESLT"});
 doc\_info.number()=0;
 
 \textcolor{comment}{// Parameters for the leaflet}
 \textcolor{comment}{//----------------------------}
 
 \textcolor{comment}{// Height}
 \textcolor{keywordtype}{double} h\_leaflet = 0.5;


 \textcolor{comment}{// Tip deflection}
 \textcolor{keywordtype}{double} d\_x = 0.25;
 \textcolor{keywordtype}{double} d\_y = -0.05;

 \textcolor{comment}{// x-positon of root}
 \textcolor{keywordtype}{double} x\_0 = 3.0; 

 \textcolor{comment}{// Period of the oscillation on the natural timescale of the flow}
 \textcolor{keywordtype}{double} period = 20.0;


 \textcolor{comment}{//Parameters for the domain}
 \textcolor{comment}{//-------------------------}

 \textcolor{comment}{// Length of the mesh to right and left of the leaflet}
 \textcolor{keywordtype}{double} l\_left =2.0;
 \textcolor{keywordtype}{double} l\_right= 3.0;

 \textcolor{comment}{// Total height of domain (unity because lengths have been scaled on it)}
 \textcolor{keywordtype}{double} h\_tot=1.0;

 \textcolor{comment}{// Initial number of element rows/columns in various mesh regions}
 \textcolor{keywordtype}{unsigned} nleft=8;
 \textcolor{keywordtype}{unsigned} nright=12;
 \textcolor{keywordtype}{unsigned} ny1=2;
 \textcolor{keywordtype}{unsigned} ny2=2; 

\end{DoxyCodeInclude}


Next we build the problem and assign the time-\/stepping parameters (as usual, fewer timesteps are used during a validation run which is identified by a non-\/zero number of command line arguments)\+:


\begin{DoxyCodeInclude}
 
 \textcolor{comment}{//Build the problem}
 \hyperlink{classChannelWithLeafletProblem}{ChannelWithLeafletProblem<AlgebraicElement<RefineableQTaylorHoodElement<2>}
       > >
  problem(l\_left, l\_right, h\_leaflet,
          h\_tot,nleft, nright,ny1,ny2,
          d\_x, d\_y, x\_0,
          period);
 
 
 \textcolor{comment}{// Number of timesteps per period}
 \textcolor{keywordtype}{unsigned} nsteps\_per\_period=40;

 \textcolor{comment}{// Number of periods}
 \textcolor{keywordtype}{unsigned} nperiod=3; 

 \textcolor{comment}{// Number of timesteps (reduced for validation)}
 \textcolor{keywordtype}{unsigned} nstep=nsteps\_per\_period*nperiod;
 \textcolor{keywordflow}{if} (CommandLineArgs::Argc>1)
  \{
   nstep=3;
  \}

 \textcolor{comment}{//Timestep: }
 \textcolor{keywordtype}{double} dt=period/double(nsteps\_per\_period);
 \textcolor{comment}{}
\textcolor{comment}{ /// Initialise timestep }
\textcolor{comment}{} problem.initialise\_dt(dt);

\end{DoxyCodeInclude}


We start the simulation with a steady solve, allowing up to five levels of adaptive refinement (fewer if we are performing a validation run)\+:


\begin{DoxyCodeInclude}

\textcolor{comment}{}
\textcolor{comment}{ /// Set max. number of adaptations (reduced for validation)}
\textcolor{comment}{} \textcolor{keywordtype}{unsigned} max\_adapt=5;
 \textcolor{keywordflow}{if} (CommandLineArgs::Argc>1)
  \{
   max\_adapt=2;
  \}

 \textcolor{comment}{// Do steady solve first -- this also sets the history values}
 \textcolor{comment}{// to those corresponding to an impulsive start from the}
 \textcolor{comment}{// steady solution}
 problem.steady\_newton\_solve(max\_adapt);
 \textcolor{comment}{}
\textcolor{comment}{ /// Output steady solution}
\textcolor{comment}{} problem.doc\_solution(doc\_info);
 doc\_info.number()++;

\end{DoxyCodeInclude}


Finally, we enter the proper timestepping loop, allowing one spatial adaptation per timestep and suppressing the re-\/assignment of initial conditions following an adaptation by setting the parameter {\ttfamily first} to false (see the discussion of timestepping with automatic mesh adaptation in \href{../../../unsteady_heat/two_d_unsteady_heat_adapt/html/index.html}{\tt another tutorial}.)


\begin{DoxyCodeInclude}

\textcolor{comment}{}
\textcolor{comment}{ /// Reduce the max number of adaptations for time-dependent simulation}
\textcolor{comment}{} max\_adapt=1;

 \textcolor{comment}{// We don't want to re-assign the initial condition }
 \textcolor{keywordtype}{bool} first=\textcolor{keyword}{false};
 
\textcolor{comment}{// Timestepping loop}
 \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} istep=0;istep<nstep;istep++)
  \{ 
   \textcolor{comment}{// Solve the problem}
   problem.unsteady\_newton\_solve(dt,max\_adapt,first);
   
   \textcolor{comment}{// Output the solution}
   problem.doc\_solution(doc\_info);
   
   \textcolor{comment}{// Step number}
   doc\_info.number()++;

  \}


\}\textcolor{comment}{//end of main}

\end{DoxyCodeInclude}




 

\hypertarget{index_problem}{}\section{The Problem class}\label{index_problem}
The problem class has the usual member functions to perform actions after the mesh adaptation and before every implicit timestep\+:

 
\begin{DoxyCodeInclude}
\textcolor{comment}{//==start\_of\_problem\_class===========================================}
\textcolor{comment}{/// Problem class}
\textcolor{comment}{}\textcolor{comment}{//===================================================================}
\textcolor{keyword}{template}<\textcolor{keyword}{class} ELEMENT>
\textcolor{keyword}{class }\hyperlink{classChannelWithLeafletProblem}{ChannelWithLeafletProblem} : \textcolor{keyword}{public} Problem
\{

\textcolor{keyword}{public}:
\textcolor{comment}{}
\textcolor{comment}{ /// Constructor: Pass the length of the domain at the left}
\textcolor{comment}{ /// of the leaflet lleft,the length of the domain at the right of the}
\textcolor{comment}{ /// leaflet lright,the height of the leaflet hleaflet, the total height}
\textcolor{comment}{ /// of the domain htot, the number of macro-elements at the left of the}
\textcolor{comment}{ /// leaflet nleft, the number of macro-elements at the right of the}
\textcolor{comment}{ /// leaflet nright, the number of macro-elements under hleaflet ny1,}
\textcolor{comment}{ /// the number of macro-elements above hleaflet ny2,the x-displacement}
\textcolor{comment}{ /// of the leaflet d\_x,the y-displacement of the leaflet d\_y,the abscissa }
\textcolor{comment}{ /// of the origin of the leaflet x\_0, the period of the moving leaflet.}
\textcolor{comment}{} \hyperlink{classChannelWithLeafletProblem_a3c5a4c97ec66fe53bc130005c74a47b5}{ChannelWithLeafletProblem}(\textcolor{keyword}{const} \textcolor{keywordtype}{double}& l\_left,
                           \textcolor{keyword}{const} \textcolor{keywordtype}{double}& l\_right, \textcolor{keyword}{const} \textcolor{keywordtype}{double}& h\_leaflet,
                           \textcolor{keyword}{const} \textcolor{keywordtype}{double}& h\_tot,
                           \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned}& nleft, \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned}& nright,
                           \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned}& ny1, \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned}&  ny2,
                           \textcolor{keyword}{const} \textcolor{keywordtype}{double}& d\_x,\textcolor{keyword}{const} \textcolor{keywordtype}{double}& d\_y,
                           \textcolor{keyword}{const} \textcolor{keywordtype}{double}& x\_0, \textcolor{keyword}{const} \textcolor{keywordtype}{double}& period);  
\textcolor{comment}{}
\textcolor{comment}{ /// Destructor (empty)}
\textcolor{comment}{} \hyperlink{classChannelWithLeafletProblem_a5dec8333d345e4bcaac7fcd5b463eafc}{~ChannelWithLeafletProblem}()\{\}
\textcolor{comment}{}
\textcolor{comment}{ /// Overloaded access function to specific mesh}
\textcolor{comment}{} RefineableAlgebraicChannelWithLeafletMesh<ELEMENT>* \hyperlink{classChannelWithLeafletProblem_a023dc7718a98f820e4bc4541150a0c08}{mesh\_pt}() 
  \{
   \textcolor{comment}{// Upcast from pointer to the Mesh base class to the specific }
   \textcolor{comment}{// element type that we're using here.}
   \textcolor{keywordflow}{return} \textcolor{keyword}{dynamic\_cast<}RefineableAlgebraicChannelWithLeafletMesh<ELEMENT>*\textcolor{keyword}{>}(
    Problem::mesh\_pt());
  \}
 \textcolor{comment}{}
\textcolor{comment}{ /// Update after solve (empty)}
\textcolor{comment}{} \textcolor{keywordtype}{void} \hyperlink{classChannelWithLeafletProblem_a2fcba9dc98f40bbca1919a715fa087d7}{actions\_after\_newton\_solve}()\{\}
\textcolor{comment}{}
\textcolor{comment}{ /// Update before solve (empty)}
\textcolor{comment}{} \textcolor{keywordtype}{void} \hyperlink{classChannelWithLeafletProblem_a5721dfad66d13a1ae60adce7801dcb12}{actions\_before\_newton\_solve}()\{\}
\textcolor{comment}{}
\textcolor{comment}{ /// Actions after adaptation: Pin redundant pressure dofs}
\textcolor{comment}{} \textcolor{keywordtype}{void} \hyperlink{classChannelWithLeafletProblem_a7978755f073d950e5012951ced9e455e}{actions\_after\_adapt}();
\textcolor{comment}{}
\textcolor{comment}{ /// Update the velocity boundary condition on the moving leaflet}
\textcolor{comment}{} \textcolor{keywordtype}{void} \hyperlink{classChannelWithLeafletProblem_acef6ec771775162f77295a8f92d695ac}{actions\_before\_implicit\_timestep}();
\textcolor{comment}{}
\textcolor{comment}{ /// Doc the solution}
\textcolor{comment}{} \textcolor{keywordtype}{void} \hyperlink{classChannelWithLeafletProblem_adb8e1420844f7b40d71beae81111c4d0}{doc\_solution}(DocInfo& doc\_info);

\textcolor{keyword}{private}:
\textcolor{comment}{}
\textcolor{comment}{ /// Pointer to the GeomObject}
\textcolor{comment}{} GeomObject* \hyperlink{classChannelWithLeafletProblem_ac32f0451749ec4e85d39246f5823a5f2}{Leaflet\_pt};
 
\};

\end{DoxyCodeInclude}




 

\hypertarget{index_constructor}{}\section{The problem constructor}\label{index_constructor}
We construct the timestepper and the {\ttfamily Geom\+Object} that represents the leaflet, and pass it pointers to them to the constructor of the {\ttfamily Refineable\+Algebraic\+Channel\+With\+Leaflet\+Mesh} (discussed in more detail in \hyperlink{index_comm_and_ex}{Further comments and exercises}).


\begin{DoxyCodeInclude}




\textcolor{comment}{//==start\_of\_constructor=================================================}\textcolor{comment}{}
\textcolor{comment}{/// Constructor}
\textcolor{comment}{}\textcolor{comment}{//=======================================================================}
\textcolor{keyword}{template} <\textcolor{keyword}{class} ELEMENT>
\hyperlink{classChannelWithLeafletProblem_a3c5a4c97ec66fe53bc130005c74a47b5}{ChannelWithLeafletProblem<ELEMENT>::ChannelWithLeafletProblem}
      (
 \textcolor{keyword}{const} \textcolor{keywordtype}{double}& l\_left,
 \textcolor{keyword}{const} \textcolor{keywordtype}{double}& l\_right, \textcolor{keyword}{const} \textcolor{keywordtype}{double}& h\_leaflet,
 \textcolor{keyword}{const} \textcolor{keywordtype}{double}& h\_tot,
 \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned}& nleft, \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned}& nright,
 \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned}& ny1, \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned}&  ny2,
 \textcolor{keyword}{const} \textcolor{keywordtype}{double}& d\_x,\textcolor{keyword}{const} \textcolor{keywordtype}{double}& d\_y,
 \textcolor{keyword}{const} \textcolor{keywordtype}{double}& x\_0, \textcolor{keyword}{const} \textcolor{keywordtype}{double}& period)
\{
 \textcolor{comment}{// Allocate the timestepper}
 add\_time\_stepper\_pt(\textcolor{keyword}{new} BDF<2>);
 
 \textcolor{comment}{//Create the geometric object that represents the leaflet}
 Leaflet\_pt = \textcolor{keyword}{new} \hyperlink{classLeaflet}{Leaflet}(h\_leaflet, d\_x, d\_y, x\_0, period, time\_pt()) ;

\textcolor{comment}{//Build the mesh}
Problem::mesh\_pt()=\textcolor{keyword}{new} RefineableAlgebraicChannelWithLeafletMesh<ELEMENT>(
 Leaflet\_pt,
 l\_left, l\_right,
 h\_leaflet,
 h\_tot,nleft,
 nright,ny1,ny2,
 time\_stepper\_pt());     

\end{DoxyCodeInclude}


Next we create the spatial error estimator and loop over the elements to set the pointers to the relevant physical parameters.


\begin{DoxyCodeInclude}


 \textcolor{comment}{// Set error estimator}
 Z2ErrorEstimator* error\_estimator\_pt=\textcolor{keyword}{new} Z2ErrorEstimator;
 \textcolor{keyword}{dynamic\_cast<}RefineableAlgebraicChannelWithLeafletMesh<ELEMENT>*\textcolor{keyword}{>}(mesh\_pt())->
  spatial\_error\_estimator\_pt()=error\_estimator\_pt;

 
 \textcolor{comment}{// Loop over the elements to set up element-specific }
 \textcolor{comment}{// things that cannot be handled by constructor}
 \textcolor{keywordtype}{unsigned} n\_element = mesh\_pt()->nelement();
 \textcolor{keywordflow}{for}(\textcolor{keywordtype}{unsigned} e=0;e<n\_element;e++)
  \{
   \textcolor{comment}{// Upcast from GeneralisedElement to the present element}
   ELEMENT* el\_pt = \textcolor{keyword}{dynamic\_cast<}ELEMENT*\textcolor{keyword}{>}(mesh\_pt()->element\_pt(e));
   
   \textcolor{comment}{//Set the Reynolds number}
   el\_pt->re\_pt() = &\hyperlink{namespaceGlobal__Physical__Variables_ab814e627d2eb5bc50318879d19ab16b9}{Global\_Physical\_Variables::Re};
  
   \textcolor{comment}{// Set the Womersley number (product of Reynolds and Strouhal).}
   \textcolor{comment}{// We're assuming a Strouhal number of one, corresponding to}
   \textcolor{comment}{// a non-dimensionalisation of time on the flow's natural timescale.}
   el\_pt->re\_st\_pt() = &\hyperlink{namespaceGlobal__Physical__Variables_ab814e627d2eb5bc50318879d19ab16b9}{Global\_Physical\_Variables::Re};
  
  \} \textcolor{comment}{// end loop over elements}

\end{DoxyCodeInclude}


The velocity is prescribed everywhere apart from the outflow boundary (boundary 1; see the sketch in \hyperlink{index_comm_and_ex}{Further comments and exercises} for the enumeration of the mesh boundaries). Along the inflow (boundary 3) we apply a parabolic velocity profile with unit flux\+:


\begin{DoxyCodeInclude}


 \textcolor{comment}{//Pin the boundary nodes}
 \textcolor{keywordtype}{unsigned} num\_bound = mesh\_pt()->nboundary();
 \textcolor{keywordflow}{for}(\textcolor{keywordtype}{unsigned} ibound=0;ibound<num\_bound;ibound++)
  \{
   \textcolor{keywordtype}{unsigned} num\_nod= mesh\_pt()->nboundary\_node(ibound);
   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} inod=0;inod<num\_nod;inod++)
    \{
      mesh\_pt()->boundary\_node\_pt(ibound,inod)->pin(1);
      \textcolor{comment}{//do not pin the x velocity of the outflow}
      \textcolor{keywordflow}{if}( ibound != 1)
      \{
       mesh\_pt()->boundary\_node\_pt(ibound,inod)->pin(0); 
      \}     
    \}
  \}
 
 \textcolor{comment}{// Setup parabolic flow along the inflow boundary 3}
 \textcolor{keywordtype}{unsigned} ibound=3; 
 \textcolor{keywordtype}{unsigned} num\_nod= mesh\_pt()->nboundary\_node(ibound);
 \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} inod=0;inod<num\_nod;inod++)
  \{
   \textcolor{keywordtype}{double} ycoord = mesh\_pt()->boundary\_node\_pt(ibound,inod)->x(1); 
   \textcolor{keywordtype}{double} uy = 6.0*(ycoord/h\_tot)*(1.0-(ycoord/h\_tot));

   mesh\_pt()->boundary\_node\_pt(ibound,inod)->set\_value(0,uy);
   mesh\_pt()->boundary\_node\_pt(ibound,inod)->set\_value(1,0.0);    
  \}\textcolor{comment}{// end of setup boundary condition}

\end{DoxyCodeInclude}


Finally, we pin the redundant pressure degrees of freedom (see \href{../../../navier_stokes/adaptive_driven_cavity/html/index.html}{\tt another tutorial} for details), and assign the equations numbers.


\begin{DoxyCodeInclude}
 
 \textcolor{comment}{// Pin redudant pressure dofs}
 RefineableNavierStokesEquations<2>::
  pin\_redundant\_nodal\_pressures(Problem::mesh\_pt()->element\_pt());
 
 \textcolor{comment}{// Setup equation numbering scheme}
 cout << \textcolor{stringliteral}{"Number of equations: "} << assign\_eqn\_numbers() << std::endl; 
 
\}\textcolor{comment}{//end of constructor}

\end{DoxyCodeInclude}




 

\hypertarget{index_timestep}{}\section{Actions before the timestep}\label{index_timestep}
Before each timestep we update the nodal positions in the mesh and re-\/apply the no-\/slip condition on the nodes of the moving leaflet (boundaries 4 and 5; see the sketch in \hyperlink{index_comm_and_ex}{Further comments and exercises} for the enumeration of the mesh boundaries).


\begin{DoxyCodeInclude}
\textcolor{comment}{//=====start\_of\_actions\_before\_implicit\_timestep=========================}
\textcolor{comment}{/// Actions before implicit timestep: Update domain shape and}
\textcolor{comment}{}\textcolor{comment}{/// the velocity boundary conditions}
\textcolor{comment}{}\textcolor{comment}{//=======================================================================}
\textcolor{keyword}{template} <\textcolor{keyword}{class} ELEMENT> 
\textcolor{keywordtype}{void} \hyperlink{classChannelWithLeafletProblem_acef6ec771775162f77295a8f92d695ac}{ChannelWithLeafletProblem<ELEMENT>::actions\_before\_implicit\_timestep}
      ()
\{
 \textcolor{comment}{// Update the domain shape}
 mesh\_pt()->node\_update();

 \textcolor{comment}{// Moving leaflet: No slip; this implies that the velocity needs}
 \textcolor{comment}{// to be updated in response to leaflet motion}
 \textcolor{keywordflow}{for}( \textcolor{keywordtype}{unsigned} ibound=4;ibound<6;ibound++)
  \{
   \textcolor{keywordtype}{unsigned} num\_nod=mesh\_pt()->nboundary\_node(ibound);
   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} inod=0;inod<num\_nod;inod++)
    \{
     \textcolor{comment}{// Which node are we dealing with?}
     Node* node\_pt=mesh\_pt()->boundary\_node\_pt(ibound,inod);
     
     \textcolor{comment}{// Apply no slip}
     FSI\_functions::apply\_no\_slip\_on\_moving\_wall(node\_pt);
    \}
  \}
\} \textcolor{comment}{//end\_of\_actions\_before\_implicit\_timestep}

\end{DoxyCodeInclude}




 

\hypertarget{index_adapt}{}\section{Actions after the mesh adaptation}\label{index_adapt}
Once the mesh has been adapted, we free all pressure degrees of freedom and then (re-\/)pin any redundant ones (see \href{../../../navier_stokes/adaptive_driven_cavity/html/index.html}{\tt another tutorial} for details)\+:


\begin{DoxyCodeInclude}
\textcolor{comment}{//==========start\_of\_actions\_after\_adaptation============================}
\textcolor{comment}{// Actions after adaptation: Pin redundant pressure dofs}
\textcolor{comment}{//=======================================================================}
\textcolor{keyword}{template}<\textcolor{keyword}{class} ELEMENT>
\textcolor{keywordtype}{void} \hyperlink{classChannelWithLeafletProblem_a7978755f073d950e5012951ced9e455e}{ChannelWithLeafletProblem<ELEMENT>::actions\_after\_adapt}
      ()
\{
 \textcolor{comment}{// Unpin all pressure dofs}
 RefineableNavierStokesEquations<2>::
  unpin\_all\_pressure\_dofs(mesh\_pt()->element\_pt());
 
 \textcolor{comment}{// Pin redundant pressure dofs}
 RefineableNavierStokesEquations<2>::
  pin\_redundant\_nodal\_pressures(mesh\_pt()->element\_pt());
 
\} \textcolor{comment}{// end\_of\_actions\_after\_adapt}

\end{DoxyCodeInclude}


Note that the default interpolation of the (quadratic!) inflow velocity profile from father to son elements during the mesh adaptation already ensures that the inflow profile remains quadratic, therefore no further action is required.



 

\hypertarget{index_doc}{}\section{Post-\/processing}\label{index_doc}
The function {\ttfamily doc\+\_\+solution}(...) documents the results.


\begin{DoxyCodeInclude}
\textcolor{comment}{//==start\_of\_doc\_solution=================================================}
\textcolor{comment}{/// Doc the solution}
\textcolor{comment}{}\textcolor{comment}{//========================================================================}
\textcolor{keyword}{template}<\textcolor{keyword}{class} ELEMENT>
\textcolor{keywordtype}{void} \hyperlink{classChannelWithLeafletProblem_adb8e1420844f7b40d71beae81111c4d0}{ChannelWithLeafletProblem<ELEMENT>::doc\_solution}(
      DocInfo& doc\_info)
\{ 

 ofstream some\_file;
 \textcolor{keywordtype}{char} filename[100];

 \textcolor{comment}{// Number of plot points}
 \textcolor{keywordtype}{unsigned} npts;
 npts=5; 

 \textcolor{comment}{// Output solution }
 sprintf(filename,\textcolor{stringliteral}{"%s/soln%i.dat"},doc\_info.directory().c\_str(),
         doc\_info.number());
 some\_file.open(filename);
 mesh\_pt()->output(some\_file,npts);
 some\_file.close();

 \textcolor{comment}{// Output boundaries}
 sprintf(filename,\textcolor{stringliteral}{"%s/boundaries%i.dat"},doc\_info.directory().c\_str(),
         doc\_info.number());
 some\_file.open(filename);
 mesh\_pt()->output\_boundaries(some\_file);
 some\_file.close();

\} \textcolor{comment}{// end\_of\_doc\_solution}

\end{DoxyCodeInclude}




 

\hypertarget{index_comm_and_ex}{}\section{Further comments and exercises}\label{index_comm_and_ex}
\hypertarget{index_comm}{}\subsection{Further comments\+: The algebraic node update procedure}\label{index_comm}
The figure below illustrates the algebraic node update procedure employed in the {\ttfamily Refineable\+Algebraic\+Channel\+With\+Leaflet\+Mesh}. The mesh employs four different node update functions, depending on which region a node is located in\+: Nodes in region I (or II) are located on straight lines that connect the upstream (or downstream) boundary with the leaflet; nodes in region I\+II (or IV) are located on straight lines that connect the upstream and (or downstream) boundary with the straight line from the tip of the leaflet to upper channel wall.

 
\begin{DoxyImage}
\includegraphics[width=0.75\textwidth]{channel_with_leaflet_mesh}
\doxyfigcaption{Sketch illustrating the algebraic node update procedure. }
\end{DoxyImage}


The implementation of the node update functions is straightforward and can be found in the source files \begin{center} \href{
../../../../src/meshes/channel_with_leaflet_mesh.template.h}{\tt src/meshes/channel\+\_\+with\+\_\+leaflet\+\_\+mesh.\+template.\+h } \end{center} ~\newline
and \begin{center} \href{
../../../../src/meshes/channel_with_leaflet_mesh.template.cc}{\tt src/meshes/channel\+\_\+with\+\_\+leaflet\+\_\+mesh.\+template.\+cc } \end{center} ~\newline
which also illustrate how the mesh is constructed by inheritance from the {\ttfamily Simple\+Rectangular\+Quad\+Mesh} (the main task being the creation of additional nodes in the interior to \char`\"{}cut open\char`\"{} the mesh along the position of the leaflet). The source files also contain other versions of the mesh in which the node update is performed with Domain/\+Macro\+Elements, using the technique described in \href{../../../poisson/fish_poisson2/html/index.html}{\tt another tutorial}.\hypertarget{index_ex}{}\subsection{Exercise}\label{index_ex}
With the node update strategy illustrated above, the position of {\itshape all} nodes in the fluid mesh has to be updated when the leaflet moves. This is not a particular problem in the current application where the node-\/update is only performed once per timestep. However, in the \href{../../../interaction/fsi_channel_with_leaflet/html/index.html}{\tt corresponding F\+SI problem }, the approach is costly because of the of large number of shape derivatives to be computed.

As an exercise, we suggest to make the node-\/update procedure more efficient by sub-\/dividing the regions upstream and downstream of the leaflet into a central section in which the nodes move in response to the motion of the leaflet (the old regions I-\/\+IV) and two additional regions (regions V and VI) in which they remain stationary. This is easy because, as explained \href{../../algebraic_collapsible_channel/html/index.html#comm}{\tt elsewhere,} all {\ttfamily Algebraic\+Nodes} already have a default node update function that leaves them stationary.

 
\begin{DoxyImage}
\includegraphics[width=0.75\textwidth]{channel_with_leaflet_better_mesh}
\doxyfigcaption{A better node update strategy. }
\end{DoxyImage}




 

\hypertarget{index_ackn}{}\section{Acknowledgements}\label{index_ackn}

\begin{DoxyItemize}
\item This code was originally developed by Floraine Cordier.
\end{DoxyItemize}



 

\hypertarget{index_sources}{}\section{Source files for this tutorial}\label{index_sources}

\begin{DoxyItemize}
\item The source files for this tutorial are located in the directory\+:~\newline
~\newline
\begin{center} \href{
../../../../
demo_drivers/navier_stokes/channel_with_leaflet/
}{\tt demo\+\_\+drivers/navier\+\_\+stokes/channel\+\_\+with\+\_\+leaflet/ } \end{center} ~\newline

\item The driver code is\+: ~\newline
~\newline
\begin{center} \href{
../../../../
demo_drivers/navier_stokes/channel_with_leaflet/channel_with_leaflet.cc
}{\tt demo\+\_\+drivers/navier\+\_\+stokes/channel\+\_\+with\+\_\+leaflet/channel\+\_\+with\+\_\+leaflet.\+cc } \end{center} 
\end{DoxyItemize}

 

 \hypertarget{index_pdf}{}\section{P\+D\+F file}\label{index_pdf}
A \href{../latex/refman.pdf}{\tt pdf version} of this document is available. \end{document}
