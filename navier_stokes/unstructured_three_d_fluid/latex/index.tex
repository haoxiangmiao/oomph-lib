This tutorial provides another demonstration of how to use 3D unstructured meshes for the solution of fluid flow problems. (The main \href{../../../meshes/mesh_from_tetgen/html/index.html}{\tt tetgen tutorial} already contains a 3D unstructured fluid example.)

The specific problem considered here also serves as a \char`\"{}warm-\/up problem\char`\"{} for the \href{../../../interaction/unstructured_three_d_fsi/html/index.html}{\tt corresponding fluid-\/structure interaction problem} in which the domain boundary is replaced by an elastic vessel.



 

\hypertarget{index_problem}{}\section{The problem}\label{index_problem}
Here is a sketch of the problem\+: Flow is driven through a 3D rigid vessel made of three rectangular tubes that meet at a common junction. The flow is driven by a prescribed pressure drop between the upstream and the two downstream ends, $ \Delta P^* = P^*_{in} - P^*_{out}, $ and we assume/impose parallel in-\/ and outflow in the inlet and outlet cross-\/sections, all of which are parallel to $ x-y $ coordinate plane.

 
\begin{DoxyImage}
\includegraphics[width=0.75\textwidth]{problem_sketch}
\doxyfigcaption{Sketch of the domain with boundary conditions. }
\end{DoxyImage}


We non-\/dimensionalise all lengths on the half-\/width, $ W $, of the square main vessel and use the overall pressure drop, $ \Delta P^* $ to define the (viscous) velocity scale \[ {\cal U} = \frac{\Delta P^*\ W}{\mu}. \] With this choice the Reynolds number becomes \[ Re = \frac{\rho {\cal U} W }{\mu} = \frac{ \Delta P^* \rho W^2 }{\mu^2}, \] and we choose to drive the flow with a dimensionless pressure drop of $ \Delta P = 1. $ An increase in Reynolds number may therefore be interpreted as in increase in the applied (dimensional) pressure drop along the vessel.



 

\hypertarget{index_mesh}{}\section{3\+D unstructured mesh generation}\label{index_mesh}
We use \href{http://www.wias-berlin.de/~si }{\tt Hang Si\textquotesingle{}s} open-\/source mesh generator \href{http://wias-berlin.de/software/tetgen//}{\tt {\ttfamily tetgen} } to generate the unstructured tetrahedral mesh \char`\"{}offline\char`\"{}. We then process the output files produced by \href{http://wias-berlin.de/software/tetgen//}{\tt {\ttfamily tetgen} } to generate an unstructured {\ttfamily oomph-\/lib} mesh.

\href{http://wias-berlin.de/software/tetgen//}{\tt {\ttfamily Tetgen} } requires the specification of the domain boundaries via so-\/called facets -- planar surface patches that are bounded by closed polygonal line segments. In our simple geometry each of the three tube segments has four external faces. Together with the three in-\/ and outflow sections this results in a total of 15 facets.

The 15 facets are defined in a {\ttfamily $\ast$.poly} file that specifies the position of the vertices, and identifies the facets via a \char`\"{}face list\char`\"{} that establishes their bounding vertices. The well-\/annotated {\ttfamily $\ast$.poly} file for this problem is located at\+:

\begin{center} \href{../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.poly}{\tt demo\+\_\+drivers/navier\+\_\+stokes/unstructured\+\_\+three\+\_\+d\+\_\+fluid/fsi\+\_\+bifurcation\+\_\+fluid.\+poly} \end{center} 

We refer to the \href{http://wias-berlin.de/software/tetgen//}{\tt {\ttfamily tetgen} webpages } and {\ttfamily oomph-\/lib\textquotesingle{}s} own \href{../../../meshes/mesh_from_tetgen/html/index.html}{\tt tetgen tutorial} for further details on how to create {\ttfamily $\ast$.poly} files.

Here is a plot of the domain specified by \href{../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.poly}{\tt fsi\+\_\+bifurcation\+\_\+fluid.\+poly}. The plot was created using {\ttfamily tetview} which is distributed with \href{http://wias-berlin.de/software/tetgen//}{\tt {\ttfamily tetgen} }.

 
\begin{DoxyImage}
\includegraphics[width=0.75\textwidth]{tetgen_boundaries}
\doxyfigcaption{The domain and its bounding facets. }
\end{DoxyImage}


Note that we have deliberately assigned a different boundary ID to each facet. This will make the assignment of the boundary condition somewhat tedious as the domain boundaries of interest tend to be represented by multiple, separate mesh boundaries. However, the assignment of distinct boundary I\+Ds for the different facets is essential for the automatic generation of boundary coordinates in the \href{../../../interaction/unstructured_three_d_fsi/html/index.html}{\tt corresponding fluid-\/structure interaction problem } and is therefore {\bfseries strongly recommended}.

\href{http://wias-berlin.de/software/tetgen//}{\tt {\ttfamily Tetgen} } generates an unstructured volumetric mesh from the information contained in the {\ttfamily $\ast$.poly} file and outputs the mesh\textquotesingle{}s nodes, elements and faces in the files
\begin{DoxyItemize}
\item \href{../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.1.node}{\tt demo\+\_\+drivers/navier\+\_\+stokes/unstructured\+\_\+three\+\_\+d\+\_\+fluid/fsi\+\_\+bifurcation\+\_\+fluid.\+1.\+node}
\item \href{../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.1.ele}{\tt demo\+\_\+drivers/navier\+\_\+stokes/unstructured\+\_\+three\+\_\+d\+\_\+fluid/fsi\+\_\+bifurcation\+\_\+fluid.\+1.\+ele}
\item \href{../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.1.face}{\tt demo\+\_\+drivers/navier\+\_\+stokes/unstructured\+\_\+three\+\_\+d\+\_\+fluid/fsi\+\_\+bifurcation\+\_\+fluid.\+1.\+face}
\end{DoxyItemize}These files can be used as input to {\ttfamily oomph-\/lib\textquotesingle{}s} {\ttfamily Tetgen\+Mesh} class, using the procedure discussed in \href{../../../meshes/mesh_from_tetgen/html/index.html}{\tt another tutorial.}

The figure below shows a {\ttfamily tetview} plot of the mesh, created with a volume constraint of 0.\+2 (i.\+e. the maximum volume of each tetrahedron is guaranteed to be less than 0.\+2 units), using the command 
\begin{DoxyCode}
tetgen -a0.2 fsi\_bifurcation\_fluid.poly 
\end{DoxyCode}


 
\begin{DoxyImage}
\includegraphics[width=0.75\textwidth]{mesh_boundaries}
\doxyfigcaption{Plot of the mesh, generated by tetgen. }
\end{DoxyImage}


Note how \href{http://wias-berlin.de/software/tetgen//}{\tt {\ttfamily tetgen} } has subdivided each of the 15 original facets specified in the {\ttfamily $\ast$.poly} file into a surface triangulation. The nodes and tetrahedral elements that are located on (or adjacent to) the 15 original facets inherit their boundary I\+Ds. This is important when we assign the boundary conditions for the actual computation.



 

\hypertarget{index_results}{}\section{Results}\label{index_results}
The plot shown below illustrates the flow field (streamribbons coloured by pressure contours) for a Reynolds number of $ Re = 100. $ The transparent faces show the boundaries of the fluid elements and illustrate that the mesh is very coarse. As a result, the flow is clearly under-\/resolved, particularly near the two outflow cross-\/sections where the imposition of parallel outflow forces the fluid velocity to re-\/adjust rapidly as it approaches the outlet. (See \hyperlink{index_finer_mesh}{Creating a finer mesh and applying more appropriate outflow boundary conditions} in \hyperlink{index_comm_ex}{Comments and Exercises} for a more detailed discussion of this aspect.)

 
\begin{DoxyImage}
\includegraphics[width=0.75\textwidth]{flow_with_stream_ribbons}
\doxyfigcaption{Flowfield (streamribbons, coloured by the pressure contours) and element boundaries. }
\end{DoxyImage}




 

\hypertarget{index_namespace}{}\section{Problem parameters}\label{index_namespace}
As usual we define the various problem parameters in a global namespace. We define the Reynolds number and specify the tractions to be applied at the in-\/ and outflow cross-\/sections\+:

 
\begin{DoxyCodeInclude}
\textcolor{comment}{//=======start\_namespace==========================================}
\textcolor{comment}{/// Global variables}
\textcolor{comment}{}\textcolor{comment}{//================================================================}
\textcolor{keyword}{namespace }\hyperlink{namespaceGlobal__Parameters}{Global\_Parameters}
\{
\textcolor{comment}{}
\textcolor{comment}{ /// Default Reynolds number}
\textcolor{comment}{} \textcolor{keywordtype}{double} \hyperlink{namespaceGlobal__Parameters_a9d72e94a9305c6a310940a6a427ebe06}{Re}=100.0;
\textcolor{comment}{}
\textcolor{comment}{ /// Fluid pressure on inflow boundary}
\textcolor{comment}{} \textcolor{keywordtype}{double} \hyperlink{namespaceGlobal__Parameters_a05b26d00935600b5e0149872844f224c}{P\_in}=0.5;
\textcolor{comment}{}
\textcolor{comment}{ /// Applied traction on fluid at the inflow boundary}
\textcolor{comment}{} \textcolor{keywordtype}{void} \hyperlink{namespaceGlobal__Parameters_af7faf65214ed9ead637f7c208addb095}{prescribed\_inflow\_traction}(\textcolor{keyword}{const} \textcolor{keywordtype}{double}& t,
                                 \textcolor{keyword}{const} Vector<double>& x,
                                 \textcolor{keyword}{const} Vector<double>& n,
                                 Vector<double>& traction)
 \{
  traction[0]=0.0;
  traction[1]=0.0;
  traction[2]=\hyperlink{namespaceGlobal__Parameters_a05b26d00935600b5e0149872844f224c}{P\_in};
 \} 

\textcolor{comment}{}
\textcolor{comment}{ /// Fluid pressure on outflow boundary}
\textcolor{comment}{} \textcolor{keywordtype}{double} \hyperlink{namespaceGlobal__Parameters_ac680ed856897793d54c9c867da19169c}{P\_out}=-0.5; 
\textcolor{comment}{}
\textcolor{comment}{ /// Applied traction on fluid at the inflow boundary}
\textcolor{comment}{} \textcolor{keywordtype}{void} \hyperlink{namespaceGlobal__Parameters_a83155358b144cff7e29ecb6b209a2d3e}{prescribed\_outflow\_traction}(\textcolor{keyword}{const} \textcolor{keywordtype}{double}& t,
                                  \textcolor{keyword}{const} Vector<double>& x,
                                  \textcolor{keyword}{const} Vector<double>& n,
                                  Vector<double>& traction)
 \{
  traction[0]=0.0;
  traction[1]=0.0;
  traction[2]=-\hyperlink{namespaceGlobal__Parameters_ac680ed856897793d54c9c867da19169c}{P\_out};
 \} 
 
\} \textcolor{comment}{//end namespace}

\end{DoxyCodeInclude}




 

\hypertarget{index_main}{}\section{The driver code}\label{index_main}
We specify an output directory, create the {\ttfamily Problem} object using ten-\/node tetrahedral Taylor-\/\+Hood elements, and output the initial guess for the flow field\+:


\begin{DoxyCodeInclude}
\textcolor{comment}{//=============start\_main=================================================}
\textcolor{comment}{/// Demonstrate how to solve an unstructured 3D fluids problem}
\textcolor{comment}{}\textcolor{comment}{//========================================================================}
\textcolor{keywordtype}{int} \hyperlink{unstructured__three__d__fluid_8cc_a3c04138a5bfe5d72780bb7e82a18e627}{main}(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} **argv)
\{
 \textcolor{comment}{// Store command line arguments}
 CommandLineArgs::setup(argc,argv);
  
 \textcolor{comment}{// Label for output}
 DocInfo doc\_info;
 
 \textcolor{comment}{// Parameter study}
 \textcolor{keywordtype}{double} Re\_increment=100.0;
 \textcolor{keywordtype}{unsigned} nstep=4;
 \textcolor{keywordflow}{if} (CommandLineArgs::Argc==2)
  \{
   std::cout << \textcolor{stringliteral}{"Validation -- only doing two steps"} << std::endl;
   nstep=2;
  \}
 
 
 \textcolor{comment}{//Taylor--Hood}
 \{
  \textcolor{comment}{// Output directory}
  doc\_info.set\_directory(\textcolor{stringliteral}{"RESLT\_TH"});
  
  \textcolor{comment}{//Set up the problem}
  \hyperlink{classUnstructuredFluidProblem}{UnstructuredFluidProblem<TTaylorHoodElement<3>} > problem;
  
  \textcolor{comment}{//Output initial guess}
  problem.\hyperlink{classUnstructuredFluidProblem_abcc9f0065665ae5239988b1a812e3f78}{doc\_solution}(doc\_info);
  doc\_info.number()++;   

\end{DoxyCodeInclude}


Next we perform a parameter study in which we increase the Reynolds number of the flow -- corresponding to an increase in the applied pressure drop. (As usual we perform a smaller number of steps in a validation run -- performed when the code is run with nonzero number of command-\/line arguments.)


\begin{DoxyCodeInclude}
  
  \textcolor{comment}{// Parameter study: Crank up the pressure drop along the vessel}
  \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} istep=0;istep<nstep;istep++)
   \{
    \textcolor{comment}{// Solve the problem}
    problem.newton\_solve();
    
    \textcolor{comment}{//Output solution}
    problem.\hyperlink{classUnstructuredFluidProblem_abcc9f0065665ae5239988b1a812e3f78}{doc\_solution}(doc\_info);
    doc\_info.number()++;
    
    \textcolor{comment}{// Bump up Reynolds number (equivalent to increasing the imposed pressure}
    \textcolor{comment}{// drop)}
    \hyperlink{namespaceGlobal__Parameters_a9d72e94a9305c6a310940a6a427ebe06}{Global\_Parameters::Re}+=Re\_increment;   
   \}
 \}

 \textcolor{comment}{//Crouzeix Raviart}
 \{
  \textcolor{comment}{//Reset to default Reynolds number}
  \hyperlink{namespaceGlobal__Parameters_a9d72e94a9305c6a310940a6a427ebe06}{Global\_Parameters::Re} = 100.0;

  \textcolor{comment}{//Reset doc info number}
  doc\_info.number()=0;   

  \textcolor{comment}{// Output directory}
  doc\_info.set\_directory(\textcolor{stringliteral}{"RESLT\_CR"});
  
  \textcolor{comment}{//Set up the problem}
  \hyperlink{classUnstructuredFluidProblem}{UnstructuredFluidProblem<TCrouzeixRaviartElement<3>} > 
      problem;

  \textcolor{comment}{//Output initial guess}
  problem.\hyperlink{classUnstructuredFluidProblem_abcc9f0065665ae5239988b1a812e3f78}{doc\_solution}(doc\_info);
  doc\_info.number()++;   
  
  \textcolor{comment}{// Parameter study: Crank up the pressure drop along the vessel}
  \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} istep=0;istep<nstep;istep++)
   \{
    \textcolor{comment}{// Solve the problem}
    problem.newton\_solve();
    
    \textcolor{comment}{//Output solution}
    problem.\hyperlink{classUnstructuredFluidProblem_abcc9f0065665ae5239988b1a812e3f78}{doc\_solution}(doc\_info);
    doc\_info.number()++;
    
    \textcolor{comment}{// Bump up Reynolds number (equivalent to increasing the imposed pressure}
    \textcolor{comment}{// drop)}
    \hyperlink{namespaceGlobal__Parameters_a9d72e94a9305c6a310940a6a427ebe06}{Global\_Parameters::Re}+=Re\_increment;   
   \}
 \}
 
\} \textcolor{comment}{// end\_of\_main}

\end{DoxyCodeInclude}




 

\hypertarget{index_class}{}\section{The Problem class}\label{index_class}
The {\ttfamily Problem} class has the usual member functions and provides explicit storage for the fluid mesh and the meshes containing the {\ttfamily Face\+Elements} that apply the traction conditions at the in-\/ and outflow boundaries. We also provide storage for the I\+Ds of the mesh boundaries that constitute the in-\/ and outflow boundaries to facilitate the application of the boundary conditions.

 
\begin{DoxyCodeInclude}
\textcolor{comment}{//======start\_problem\_class===========================================}
\textcolor{comment}{/// Unstructured fluid problem}
\textcolor{comment}{}\textcolor{comment}{//====================================================================}
\textcolor{keyword}{template}<\textcolor{keyword}{class} ELEMENT>
\textcolor{keyword}{class }\hyperlink{classUnstructuredFluidProblem}{UnstructuredFluidProblem} : \textcolor{keyword}{public} Problem
\{

\textcolor{keyword}{public}:
\textcolor{comment}{}
\textcolor{comment}{ /// Constructor: }
\textcolor{comment}{} \hyperlink{classUnstructuredFluidProblem_a9751f4afac540e148b3d90ae43dd5187}{UnstructuredFluidProblem}();
\textcolor{comment}{}
\textcolor{comment}{ /// Destructor (empty)}
\textcolor{comment}{} \hyperlink{classUnstructuredFluidProblem_a4d660faa6bae35197a4ea73139ac9963}{~UnstructuredFluidProblem}()\{\}
\textcolor{comment}{}
\textcolor{comment}{ /// Doc the solution}
\textcolor{comment}{} \textcolor{keywordtype}{void} \hyperlink{classUnstructuredFluidProblem_abcc9f0065665ae5239988b1a812e3f78}{doc\_solution}(DocInfo& doc\_info);
 \textcolor{comment}{}
\textcolor{comment}{ /// Return total number of fluid inflow traction boundaries}
\textcolor{comment}{} \textcolor{keywordtype}{unsigned} \hyperlink{classUnstructuredFluidProblem_a8afc18327561107094fa94f2918a385f}{nfluid\_inflow\_traction\_boundary}()
  \{
   \textcolor{keywordflow}{return} \hyperlink{classUnstructuredFluidProblem_a2923e009bcea7cdbdd7ea5788580a3f8}{Inflow\_boundary\_id}.size();
  \}
\textcolor{comment}{}
\textcolor{comment}{ /// Return total number of fluid outflow traction boundaries}
\textcolor{comment}{} \textcolor{keywordtype}{unsigned} \hyperlink{classUnstructuredFluidProblem_abcaa700f2e0e1b2097e7dc25fe087862}{nfluid\_outflow\_traction\_boundary}()
  \{
   \textcolor{keywordflow}{return} \hyperlink{classUnstructuredFluidProblem_a9bace139103152045dfe88e3d0163811}{Outflow\_boundary\_id}.size();
  \}
\textcolor{comment}{}
\textcolor{comment}{ /// Return total number of fluid outflow traction boundaries}
\textcolor{comment}{} \textcolor{keywordtype}{unsigned} \hyperlink{classUnstructuredFluidProblem_ae04e768e915a5e097527cea22558203d}{nfluid\_traction\_boundary}()
  \{
   \textcolor{keywordflow}{return} \hyperlink{classUnstructuredFluidProblem_a2923e009bcea7cdbdd7ea5788580a3f8}{Inflow\_boundary\_id}.size()+\hyperlink{classUnstructuredFluidProblem_a9bace139103152045dfe88e3d0163811}{Outflow\_boundary\_id}.size();
  \}

 \textcolor{comment}{//private:}
\textcolor{comment}{}
\textcolor{comment}{ /// Create fluid traction elements at inflow}
\textcolor{comment}{} \textcolor{keywordtype}{void} \hyperlink{classUnstructuredFluidProblem_ae95f1912572e8a5f0543eab9c0eb2634}{create\_fluid\_traction\_elements}();
\textcolor{comment}{}
\textcolor{comment}{ /// Bulk fluid mesh}
\textcolor{comment}{} TetgenMesh<ELEMENT>* \hyperlink{classUnstructuredFluidProblem_ade90cb92dd49b9d897ed538b1876b060}{Fluid\_mesh\_pt};
\textcolor{comment}{}
\textcolor{comment}{ /// Meshes of fluid traction elements that apply pressure at in/outflow}
\textcolor{comment}{} Vector<Mesh*> \hyperlink{classUnstructuredFluidProblem_ad2fd96c077dbc69077daaf20a314896c}{Fluid\_traction\_mesh\_pt};
\textcolor{comment}{}
\textcolor{comment}{ /// \(\backslash\)short IDs of fluid mesh boundaries along which inflow boundary conditions}
\textcolor{comment}{ /// are applied}
\textcolor{comment}{} Vector<unsigned> \hyperlink{classUnstructuredFluidProblem_a2923e009bcea7cdbdd7ea5788580a3f8}{Inflow\_boundary\_id};
\textcolor{comment}{}
\textcolor{comment}{ /// \(\backslash\)short IDs of fluid mesh boundaries along which inflow boundary conditions}
\textcolor{comment}{ /// are applied}
\textcolor{comment}{} Vector<unsigned> \hyperlink{classUnstructuredFluidProblem_a9bace139103152045dfe88e3d0163811}{Outflow\_boundary\_id};

\};

\end{DoxyCodeInclude}




 

\hypertarget{index_constructor}{}\section{The Problem constructor}\label{index_constructor}
We start by building the fluid mesh, using the files created by \href{http://wias-berlin.de/software/tetgen//}{\tt {\ttfamily tetgen} }\+:


\begin{DoxyCodeInclude}
\textcolor{comment}{//==========start\_constructor=============================================}
\textcolor{comment}{/// Constructor for unstructured 3D fluid problem}
\textcolor{comment}{}\textcolor{comment}{//========================================================================}
\textcolor{keyword}{template}<\textcolor{keyword}{class} ELEMENT>
\hyperlink{classUnstructuredFluidProblem_a9751f4afac540e148b3d90ae43dd5187}{UnstructuredFluidProblem<ELEMENT>::UnstructuredFluidProblem}
      ()
\{ 
 
 \textcolor{comment}{//Create fluid bulk mesh, sub-dividing "corner" elements}
 \textcolor{keywordtype}{string} node\_file\_name=\textcolor{stringliteral}{"fsi\_bifurcation\_fluid.1.node"};
 \textcolor{keywordtype}{string} element\_file\_name=\textcolor{stringliteral}{"fsi\_bifurcation\_fluid.1.ele"};
 \textcolor{keywordtype}{string} face\_file\_name=\textcolor{stringliteral}{"fsi\_bifurcation\_fluid.1.face"};
 \textcolor{keywordtype}{bool} split\_corner\_elements=\textcolor{keyword}{true};
 Fluid\_mesh\_pt =  \textcolor{keyword}{new} TetgenMesh<ELEMENT>(node\_file\_name,
                                          element\_file\_name,
                                          face\_file\_name,
                                          split\_corner\_elements);

\end{DoxyCodeInclude}


(We refer to the subsection \hyperlink{index_split}{Splitting corner elements in unstructured meshes to avoid locking} in the section \hyperlink{index_comm_ex}{Comments and Exercises} for a discussion of the {\ttfamily split\+\_\+corner\+\_\+elements} flag).

Next, we set up the boundary lookup schemes that determine which elements are located next to which domain boundaries, and specify the I\+Ds of the mesh boundaries that coincide with the in-\/ and outflow cross-\/sections. Note that this information reflects the specification of the boundary I\+Ds in the {\ttfamily tetgen} {\ttfamily $\ast$.poly} file.


\begin{DoxyCodeInclude}
 
 \textcolor{comment}{// Find elements next to boundaries}
 \textcolor{comment}{//Fluid\_mesh\_pt->setup\_boundary\_element\_info();}

 \textcolor{comment}{// The following corresponds to the boundaries as specified by}
 \textcolor{comment}{// facets in the tetgen input:}

 \textcolor{comment}{// Fluid mesh has one inflow boundary: Boundary 0}
 Inflow\_boundary\_id.resize(1);
 Inflow\_boundary\_id[0]=0;
 
 \textcolor{comment}{// Fluid mesh has two outflow boundaries: Boundaries 1 and 2}
 Outflow\_boundary\_id.resize(2);
 Outflow\_boundary\_id[0]=1;
 Outflow\_boundary\_id[1]=2;

\end{DoxyCodeInclude}


Next we apply the boundary conditions. We impose parallel in-\/ and outflow by pinning the transverse velocities at all nodes that are located on the in-\/ and outflow boundaries, identifying the nodes via the boundary I\+Ds just set up. We use the boolean map {\ttfamily done} to indicate which boundaries we have visited already.


\begin{DoxyCodeInclude}
 
 \textcolor{comment}{// Apply BCs}
 \textcolor{comment}{//----------}
 
 \textcolor{comment}{// Map to indicate which boundary has been done}
 std::map<unsigned,bool> done; 
  
 \textcolor{comment}{// Loop over inflow/outflow boundaries to impose parallel flow}
 \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} in\_out=0;in\_out<2;in\_out++)
  \{
   \textcolor{comment}{// Loop over in/outflow boundaries}
   \textcolor{keywordtype}{unsigned} n=nfluid\_inflow\_traction\_boundary();
   \textcolor{keywordflow}{if} (in\_out==1) n=nfluid\_outflow\_traction\_boundary();
   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} i=0;i<n;i++)
    \{
     \textcolor{comment}{// Get boundary ID}
     \textcolor{keywordtype}{unsigned} b=0;
     \textcolor{keywordflow}{if} (in\_out==0)
      \{
       b=Inflow\_boundary\_id[i];
      \}
     \textcolor{keywordflow}{else}
      \{
       b=Outflow\_boundary\_id[i];
      \}

     \textcolor{comment}{// Number of nodes on that boundary}
     \textcolor{keywordtype}{unsigned} num\_nod=Fluid\_mesh\_pt->nboundary\_node(b);
     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} inod=0;inod<num\_nod;inod++)
      \{
       \textcolor{comment}{// Get the node}
       Node* nod\_pt=Fluid\_mesh\_pt->boundary\_node\_pt(b,inod);
       
       \textcolor{comment}{// Pin transverse velocities}
       nod\_pt->pin(0);
       nod\_pt->pin(1);
      \}
     
     \textcolor{comment}{// Done!}
     done[b]=\textcolor{keyword}{true};
    \}

  \} \textcolor{comment}{// done in and outflow}

\end{DoxyCodeInclude}


The nodes on all other boundaries (i.\+e. the ones for which {\ttfamily done}\mbox{[}b\mbox{]} is still {\ttfamily false}) are subjected to no-\/slip conditions by pinning all three velocity components. (This approach facilitates the \char`\"{}extension\char`\"{} of the mesh discussed in section \hyperlink{index_finer_mesh}{Creating a finer mesh and applying more appropriate outflow boundary conditions}, but we note that, in general, keeping track of the boundary I\+Ds associated with each physical boundary must be done \char`\"{}by hand\char`\"{}. )


\begin{DoxyCodeInclude}
 
 
 
 \textcolor{comment}{// Loop over all fluid mesh boundaries and pin velocities}
 \textcolor{comment}{// of nodes that haven't been dealt with yet}
 \textcolor{keywordtype}{unsigned} nbound=Fluid\_mesh\_pt->nboundary();
 \textcolor{keywordflow}{for}(\textcolor{keywordtype}{unsigned} b=0;b<nbound;b++)
  \{

   \textcolor{comment}{// Has the boundary been done yet?}
   \textcolor{keywordflow}{if} (!done[b])
    \{
     \textcolor{keywordtype}{unsigned} num\_nod=Fluid\_mesh\_pt->nboundary\_node(b);
     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} inod=0;inod<num\_nod;inod++)
      \{
       \textcolor{comment}{// Get node}
       Node* nod\_pt= Fluid\_mesh\_pt->boundary\_node\_pt(b,inod);
       
       \textcolor{comment}{// Pin all velocities}
       nod\_pt->pin(0); 
       nod\_pt->pin(1); 
       nod\_pt->pin(2); 
      \}
    \}

  \} \textcolor{comment}{// done no slip elsewhere }

\end{DoxyCodeInclude}


We complete the build of the Navier-\/\+Stokes elements by specifying the pointer to the Reynolds number,


\begin{DoxyCodeInclude}
 
 
 \textcolor{comment}{// Complete the build of the fluid elements so they are fully functional}
 \textcolor{comment}{//----------------------------------------------------------------------}
 \textcolor{keywordtype}{unsigned} n\_element = Fluid\_mesh\_pt->nelement();
 \textcolor{keywordflow}{for}(\textcolor{keywordtype}{unsigned} e=0;e<n\_element;e++)
  \{

   \textcolor{comment}{// Upcast from GeneralisedElement to the present element}
   ELEMENT* el\_pt = \textcolor{keyword}{dynamic\_cast<}ELEMENT*\textcolor{keyword}{>}(Fluid\_mesh\_pt->element\_pt(e));
   
   \textcolor{comment}{//Set the Reynolds number}
   el\_pt->re\_pt() = &\hyperlink{namespaceGlobal__Parameters_a9d72e94a9305c6a310940a6a427ebe06}{Global\_Parameters::Re};   

  \} 

\end{DoxyCodeInclude}


and attach the {\ttfamily Face\+Elements} that apply the imposed in-\/ and outflow tractions to the appropriate faces of the elements on the in-\/ and outflow boundaries\+:


\begin{DoxyCodeInclude}
 
 
 \textcolor{comment}{// Create meshes of fluid traction elements at inflow/outflow}
 \textcolor{comment}{//-----------------------------------------------------------}
 
 \textcolor{comment}{// Create the meshes}
 \textcolor{keywordtype}{unsigned} n=nfluid\_traction\_boundary();
 Fluid\_traction\_mesh\_pt.resize(n);
 \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} i=0;i<n;i++)
  \{
   Fluid\_traction\_mesh\_pt[i]=\textcolor{keyword}{new} Mesh;
  \} 
 
 \textcolor{comment}{// Populate them with elements}
 create\_fluid\_traction\_elements();

\end{DoxyCodeInclude}


Finally, we combine the various sub-\/meshes to a combined global mesh and assign the equation numbers.


\begin{DoxyCodeInclude}
 
 
 \textcolor{comment}{// Combine the lot}
 \textcolor{comment}{//----------------}
 
 \textcolor{comment}{// Add sub meshes:}

 \textcolor{comment}{// Fluid bulk mesh}
 add\_sub\_mesh(Fluid\_mesh\_pt);
 
 \textcolor{comment}{// The fluid traction meshes}
 n=nfluid\_traction\_boundary();
 \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} i=0;i<n;i++)
  \{ 
   add\_sub\_mesh(Fluid\_traction\_mesh\_pt[i]);
  \}
 
 \textcolor{comment}{// Build global mesh}
 build\_global\_mesh();

 \textcolor{comment}{// Setup equation numbering scheme}
 std::cout <<\textcolor{stringliteral}{"Number of equations: "} << assign\_eqn\_numbers() << std::endl; 
 
\} \textcolor{comment}{// end constructor}

\end{DoxyCodeInclude}




 

\hypertarget{index_traction}{}\section{Creating the fluid traction elements}\label{index_traction}
The helper function {\ttfamily create\+\_\+fluid\+\_\+traction\+\_\+elements()} loops over the bulk elements that are adjacent to the in-\/ and outflow cross-\/sections and attaches {\ttfamily Navier\+Stokes\+Traction\+Elements} to the relevant faces. We store pointers to the newly-\/created elements in the appropriate meshes, and pass pointers to the functions that specify the imposed traction to the elements.


\begin{DoxyCodeInclude}
\textcolor{comment}{//============start\_of\_fluid\_traction\_elements==============================}
\textcolor{comment}{/// Create fluid traction elements }
\textcolor{comment}{}\textcolor{comment}{//=======================================================================}
\textcolor{keyword}{template}<\textcolor{keyword}{class} ELEMENT>
\textcolor{keywordtype}{void} \hyperlink{classUnstructuredFluidProblem_ae95f1912572e8a5f0543eab9c0eb2634}{UnstructuredFluidProblem<ELEMENT>::create\_fluid\_traction\_elements}
      ()
\{

 \textcolor{comment}{// Counter for number of fluid traction meshes}
 \textcolor{keywordtype}{unsigned} count=0;

 \textcolor{comment}{// Loop over inflow/outflow boundaries}
 \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} in\_out=0;in\_out<2;in\_out++)
  \{
   \textcolor{comment}{// Loop over boundaries with fluid traction elements}
   \textcolor{keywordtype}{unsigned} n=nfluid\_inflow\_traction\_boundary();
   \textcolor{keywordflow}{if} (in\_out==1) n=nfluid\_outflow\_traction\_boundary();
   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} i=0;i<n;i++)
    \{
     \textcolor{comment}{// Get boundary ID}
     \textcolor{keywordtype}{unsigned} b=0;
     \textcolor{keywordflow}{if} (in\_out==0)
      \{
       b=Inflow\_boundary\_id[i];
      \}
     \textcolor{keywordflow}{else}
      \{
       b=Outflow\_boundary\_id[i];
      \}
     
     \textcolor{comment}{// How many bulk elements are adjacent to boundary b?}
     \textcolor{keywordtype}{unsigned} n\_element = Fluid\_mesh\_pt->nboundary\_element(b);
     
     \textcolor{comment}{// Loop over the bulk elements adjacent to boundary b}
     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{unsigned} e=0;e<n\_element;e++)
      \{
       \textcolor{comment}{// Get pointer to the bulk element that is adjacent to boundary b}
       ELEMENT* bulk\_elem\_pt = \textcolor{keyword}{dynamic\_cast<}ELEMENT*\textcolor{keyword}{>}(
        Fluid\_mesh\_pt->boundary\_element\_pt(b,e));
       
       \textcolor{comment}{//What is the index of the face of the element e along boundary b}
       \textcolor{keywordtype}{int} face\_index = Fluid\_mesh\_pt->face\_index\_at\_boundary(b,e);
       
       \textcolor{comment}{// Create new element }
       NavierStokesTractionElement<ELEMENT>* el\_pt=
        \textcolor{keyword}{new} NavierStokesTractionElement<ELEMENT>(bulk\_elem\_pt,
                                                       face\_index);
       
       \textcolor{comment}{// Add it to the mesh}
       Fluid\_traction\_mesh\_pt[count]->add\_element\_pt(el\_pt);
       
       \textcolor{comment}{// Set the pointer to the prescribed traction function}
       \textcolor{keywordflow}{if} (in\_out==0)
        \{
         el\_pt->traction\_fct\_pt() = 
          &\hyperlink{namespaceGlobal__Parameters_af7faf65214ed9ead637f7c208addb095}{Global\_Parameters::prescribed\_inflow\_traction};
        \}
       \textcolor{keywordflow}{else}
        \{
         el\_pt->traction\_fct\_pt() = 
          &\hyperlink{namespaceGlobal__Parameters_a83155358b144cff7e29ecb6b209a2d3e}{Global\_Parameters::prescribed\_outflow\_traction};
        \}
      \}
     \textcolor{comment}{// Bump up counter}
     count++;
    \}
  \}
 
 \} \textcolor{comment}{// end of create\_traction\_elements}

\end{DoxyCodeInclude}




 

\hypertarget{index_doc}{}\section{Post-\/processing}\label{index_doc}
The post-\/processing routine outputs the flow field. 
\begin{DoxyCodeInclude}



\textcolor{comment}{//========================================================================}\textcolor{comment}{}
\textcolor{comment}{/// Doc the solution}
\textcolor{comment}{}\textcolor{comment}{//========================================================================}
\textcolor{keyword}{template}<\textcolor{keyword}{class} ELEMENT>
\textcolor{keywordtype}{void} \hyperlink{classUnstructuredFluidProblem_abcc9f0065665ae5239988b1a812e3f78}{UnstructuredFluidProblem<ELEMENT>::doc\_solution}(DocInfo
      & doc\_info)
\{ 

 ofstream some\_file;
 \textcolor{keywordtype}{char} filename[100];

 \textcolor{comment}{// Number of plot points}
 \textcolor{keywordtype}{unsigned} npts;
 npts=5;
  
 
 \textcolor{comment}{// Output fluid solution}
 sprintf(filename,\textcolor{stringliteral}{"%s/fluid\_soln%i.dat"},doc\_info.directory().c\_str(),
         doc\_info.number());
 some\_file.open(filename);
 Fluid\_mesh\_pt->output(some\_file,npts);
 some\_file.close();
  
\}

\end{DoxyCodeInclude}




 

\hypertarget{index_comm_ex}{}\section{Comments and Exercises}\label{index_comm_ex}


\hypertarget{index_split}{}\subsection{Splitting corner elements in unstructured meshes to avoid locking}\label{index_split}
Meshes generated by \href{http://wias-berlin.de/software/tetgen//}{\tt {\ttfamily tetgen} } tend to be of very high quality and can usually be used without further modification. However, in Navier-\/\+Stokes computations (or other problems in which the elements have to satisfy an L\+B\+B-\/type stability constraint) problems can arise if too many of an element\textquotesingle{}s nodes are constrained by boundary conditions, causing the discretisation to \char`\"{}lock\char`\"{}. This tends to happen when three of the element\textquotesingle{}s four faces are located on domain boundaries, as in the case of the top-\/left and bottom-\/left elements in the inflow cross-\/section shown below.

 
\begin{DoxyImage}
\includegraphics[width=0.75\textwidth]{mesh_without_split}
\doxyfigcaption{Plot of the mesh generated by tetgen. }
\end{DoxyImage}


Ten-\/noded tetrahedral elements have nodes at their vertices and on their edges only. Therefore all the nodes in these particular two elements are located on domain boundaries. Furthermore, only one of these (the node halfway along the edge that traverses the inflow cross-\/section) is unconstrained; the imposition of parallel flow at the inflow face only constrains the node\textquotesingle{}s transverse velocities. Thus, both elements have a single velocity degree of freedom (the axial velocity at the node on the inflow face) but they retain their four pressure degrees of freedom (the pressures at their vertices). This does not {\itshape necessarily} over-\/constrain the problem (and in the present problem it does not) -- \char`\"{}locking\char`\"{}, due to the presence of too many pressure degrees of freedom, arises at the level of the global, fully-\/assembled problem, not on an element-\/by-\/element basis. However, the presence of such elements makes the occurrence of locking more likely and we have occasionally come across examples in which locking does occur. The remedy would be to pin exactly the required number of superfluous pressure degrees of freedom (no more and no fewer!) to \char`\"{}unlock\char`\"{} the problem. However, the diagnosis of the problem is as difficult as its practical resolution\+: How do we determine in advance if a problem will lock and, if so, which pressures should be pinned, etc.?

To avoid the problem altogether, {\ttfamily oomph-\/lib\textquotesingle{}s} {\ttfamily Tetgen\+Mesh} constructor provides an optional boolean flag, {\ttfamily split\+\_\+corner\+\_\+elements}. If this flag is set to {\ttfamily true}, the mesh constructor identifies all elements in which at least three faces are located on mesh boundaries. These elements are then split into four smaller ones, using a localised refinement as shown in this plot\+:

 
\begin{DoxyImage}
\includegraphics[width=0.75\textwidth]{mesh_with_split}
\doxyfigcaption{Plot of the mesh after splitting corner elements. }
\end{DoxyImage}


Note that the localised refinement leads to a small deterioration in the element quality but this is usually acceptable. If you are concerned about this aspect, allow the splitting of corner elements only if locking actually occurs (see below), or try to generate a different {\ttfamily tetgen} mesh that does not suffer from this problem, e.\+g. by imposing a different volume constraint.

\begin{center} {\bfseries How to spot \char`\"{}locking\char`\"{}\+:} \end{center} 
\begin{DoxyItemize}
\item If a solution can be computed (using a direct solver) the occurrence of \char`\"{}locking\char`\"{} is easy to spot\+: Typically the pressure in over-\/constrained elements becomes extremely large while the rest of the flow field looks fairly normal. Iterative solvers may fail to converge. If you suspect that locking may have occurred, try re-\/computing the solution on a mesh with the {\ttfamily split\+\_\+corner\+\_\+elements} flag set to {\ttfamily true}.
\end{DoxyItemize}

\hypertarget{index_finer_mesh}{}\subsection{Creating a finer mesh and applying more appropriate outflow boundary conditions}\label{index_finer_mesh}
The flow field shown in the \hyperlink{index_results}{Results} section is clearly under-\/resolved and a much finer mesh would have to be used to fully resolve all flow features. The problem is particularly bad because we have imposed parallel outflow (i.\+e. flow in the $ z $-\/direction) at the ends of tubes whose axes are not aligned with the $ z $-\/axis. This creates thin outflow boundary layers within which the flow is forced to change direction as it exits the tubes. These observations motivate the following exercises that allow you to explore unstructured mesh generation.


\begin{DoxyItemize}
\item {\bfseries Exercise 1\+: Refining the mesh} ~\newline
~\newline
 Create a finer mesh by specifying a smaller volume constraint for tetgen. For instance, using ~\newline
 ~\newline

\begin{DoxyCode}
tetgen -a0.02 fsi\_bifurcation\_fluid.poly
\end{DoxyCode}
 ~\newline
 will generate a much finer mesh, containing 3345 tets. Note that the driver code can remain completely unchanged. ~\newline
~\newline

\item {\bfseries Exercise 2\+: Add straight outflow vessels} ~\newline
~\newline
 The imposition of parallel flow at the outlet boundaries would be less problematic if at least the final part of the two outflow tubes was aligned with the $ z $-\/axis. Modify the file {\ttfamily \href{../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.poly}{\tt fsi\+\_\+bifurcation\+\_\+fluid.\+poly} } so that two straight vessel segments, parallel to the $ z $-\/axis, are added to the mesh. The modification to the {\ttfamily $\ast$.poly} file should be straightforward. You have to add eight additional vertices and faces, and re-\/define the two outflow faces. ~\newline
~\newline
 Here is a sample plot of a modified mesh in which two additional straight segments of different lengths have been attached to the downstream tubes. Note that the enumeration of the in-\/ and outflow boundaries was retained, allowing the mesh to be used with the same driver code. ~\newline
~\newline
 
\begin{DoxyImage}
\includegraphics[width=0.75\textwidth]{mesh_boundaries_extended}
\doxyfigcaption{Plot of the mesh, with two straight segments added to the outflow branches. }
\end{DoxyImage}
 ~\newline
 The modified mesh was created with the file {\ttfamily \href{../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid_with_extended_tubes.poly}{\tt fsi\+\_\+bifurcation\+\_\+fluid\+\_\+with\+\_\+extended\+\_\+tubes.\+poly} } which you may wish to consult. However, we do encourage you to do this exercise by yourself first, in order to familiarise yourself with {\ttfamily tetgen} -- you will notice that {\ttfamily tetgen} is not very forgiving (or verbose) when it encounters errors in the {\ttfamily $\ast$.poly} file. ~\newline
~\newline

\item {\bfseries Exercise 3\+: Use Lagrange multipliers to allow parallel outflow in cross-\/sections that are not aligned with the coordinate axes.} ~\newline
~\newline
 The main (only?) reason why we tend to impose parallel in-\/ or outflow in cross-\/sections that are aligned with the Cartesian coordinate planes is, of course, that such boundary conditions are easiest to apply in a discretisation that is based on the Cartesian form of the Navier-\/\+Stokes equations. What if we wished to impose parallel outflow from cross-\/sections that are not aligned with such planes? The proper way to do this is to use Lagrange multipliers to enforce the two constraints \[ {\bf u} \cdot {\bf t}_\alpha = 0 \mbox{\ \ \ \ for $\alpha = 1,2$,} \] where $ {\bf t}_\alpha $ (for $\alpha = 1,2$) are the two tangent vectors spanning the in-\/ or outflow cross-\/sections. The imposition of these constraints requires two Lagrange multiplier fields, defined in the in-\//outflow cross-\/sections. Physically, these Lagrange multipliers act as tangential tractions that enforce the parallel in-\/ or outflow. The Lagrange multipliers introduce additional degrees of freedom into the problem and an implementation can be based on an extension of the existing {\ttfamily Navier\+Stokes\+Traction\+Elements}, using a technique similar to that used to enforce prescribed boundary displacements in solid mechanics problems, discussed in \href{../../../solid/prescribed_displ_lagr_mult/html/index.html}{\tt another tutorial.} Note that, compared to the previous two exercises, this one is not entirely trivial. An implementation is provided in {\ttfamily Impose\+Parallel\+Outflow\+Element}, but, as always, it is more instructive to try to write it yourself!
\end{DoxyItemize}



 

\hypertarget{index_sources}{}\section{Source files for this tutorial}\label{index_sources}

\begin{DoxyItemize}
\item The source files for this tutorial are located in the directory\+:~\newline
~\newline
\begin{center} \href{../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/}{\tt demo\+\_\+drivers/navier\+\_\+stokes/unstructured\+\_\+three\+\_\+d\+\_\+fluid/ } \end{center} ~\newline

\item The driver code is\+: ~\newline
~\newline
\begin{center} \href{../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/unstructured_three_d_fluid.cc}{\tt demo\+\_\+drivers/navier\+\_\+stokes/unstructured\+\_\+three\+\_\+d\+\_\+fluid/unstructured\+\_\+three\+\_\+d\+\_\+fluid.\+cc } \end{center} 
\end{DoxyItemize}



 

 \hypertarget{index_pdf}{}\section{P\+D\+F file}\label{index_pdf}
A \href{../latex/refman.pdf}{\tt pdf version} of this document is available. \end{document}
