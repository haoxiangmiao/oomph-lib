Simulations of time-\/dependent problem can be very time consuming and it is important to be able to restart simulations, e.\+g. to continue a run after a system crash, etc. We shall illustrate {\ttfamily oomph-\/lib\textquotesingle{}s} dump/restart capabilities by re-\/visiting the 2D unsteady heat equation discussed in a \href{../../two_d_unsteady_heat/html/index.html}{\tt previous example.}

\begin{center} \tabulinesep=1mm
\begin{longtabu} spread 0pt [c]{*{1}{|X[-1]}|}
\hline
\begin{center} {\bfseries The two-\/dimensional unsteady heat equation in a square domain.} \end{center}  Solve \[ \sum_{i=1}^2\frac{\partial^2 u}{\partial x_i^2} = \frac{\partial u}{\partial t} + f\left(x_1,x_2,t\right), \ \ \ \ \ \ \ \ \ \ (1) \] in the square domain $ D = \{x_i \in [0,1]; i=1,2 \} $ , subject to the Dirichlet boundary conditions \[ \left. u\right|_{\partial D}=g_0 \ \ \ \ \ \ \ \ \ \ (2) \] and initial conditions \[ u(x_1,x_2,t=0)=h_0(x_1,x_2), \ \ \ \ \ \ \ \ \ \ (3) \] where the functions $ g_0 $ and $ h_0 $ are given.   \\\cline{1-1}
\end{longtabu}
\end{center} 

As before, we consider the unforced case, $ f=0 $, and choose boundary and initial conditions that are consistent with the exact solution \[ u_0(x_1,x_2,t) = e^{-Kt}\sin\left( \sqrt{K} \left( x_1 \cos \Phi + x_2 \sin \Phi\right)\right), \ \ \ \ \ \ \ \ \ \ (4) \] where $ K $ and $ \Phi $ are constants, controlling the decay rate of the solution and its spatial orientation, respectively.

The figure below shows a plot of computed and exact solution at a control node as a function of time. The solid lines represent quantities computed during the original simulation; the dashed line shows the corresponding data from a second simulation that was restarted with the restart file generated at timestep 23 of the original simulation.

 
\begin{DoxyImage}
\includegraphics[width=0.75\textwidth]{trace}
\doxyfigcaption{Time evolution of the computed and exact solutions at a control node, the global error norm and the norm of the solution. Solid lines\+: original simulation; dashed lines\+: restarted simulation. }
\end{DoxyImage}


Most of the driver code for this example is identical to that discussed in the \href{../../two_d_unsteady_heat/html/index.html}{\tt previous example,} therefore we only discuss the modifications required to enable the dump and restart operations\+:
\begin{DoxyItemize}
\item We use optional command line arguments to specify the name of the restart file. If the code is run without any command line arguments, we start the simulation at time $ t=0 $ and generate the initial conditions as in the \href{../../two_d_unsteady_heat/html/index.html}{\tt previous example}
\item We add dump and restart functions to the Problem class and call the dump function when post-\/processing the solution in {\ttfamily doc\+\_\+solution}(...).
\item We modify the Problem member function {\ttfamily set\+\_\+initial\+\_\+condition()} so that the initial conditions are read from the restart file if a restart file was specified on the command line.
\end{DoxyItemize}

 

\hypertarget{index_namespace}{}\section{Global parameters and functions}\label{index_namespace}
The namespace {\ttfamily \hyperlink{namespaceExactSolnForUnsteadyHeat}{Exact\+Soln\+For\+Unsteady\+Heat}} that stores the problem parameters is identical to that in the \href{../../two_d_unsteady_heat/html/index.html}{\tt previous example.}



 

\hypertarget{index_main}{}\section{The driver code}\label{index_main}
The only change to the main function is that we record the command line arguments and store them in the namespace {\ttfamily Command\+Line\+Args} 

 
\begin{DoxyCodeInclude}
\textcolor{comment}{//=======start\_of\_main====================================================}
\textcolor{comment}{/// \(\backslash\)short Driver code for unsteady heat equation with option for}
\textcolor{comment}{}\textcolor{comment}{/// restart from disk: Only a single command line argument is allowed.}
\textcolor{comment}{}\textcolor{comment}{/// If specified it is interpreted as the name of the restart file.}
\textcolor{comment}{}\textcolor{comment}{//========================================================================}
\textcolor{keywordtype}{int} \hyperlink{two__d__unsteady__heat_8cc_ae66f6b31b5ad750f1fe042a706a4e3d4}{main}(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char}* argv[])
\{

 \textcolor{comment}{// Store command line arguments}
 CommandLineArgs::setup(argc,argv);

\end{DoxyCodeInclude}


The rest of the main function is identical to that in the \href{../../two_d_unsteady_heat/html/index.html}{\tt previous example.}



 

\hypertarget{index_problem}{}\section{The problem class}\label{index_problem}
The problem class contains the two additional member functions

 
\begin{DoxyCodeInclude}
 \textcolor{comment}{/// \(\backslash\)short Dump problem to disk to allow for restart.}
 \textcolor{keywordtype}{void} dump\_it(ofstream& dump\_file);
\textcolor{comment}{}
\textcolor{comment}{ /// \(\backslash\)short Read problem for restart from specified restart file.}
\textcolor{comment}{} \textcolor{keywordtype}{void} restart(ifstream& restart\_file);

\end{DoxyCodeInclude}




 

\hypertarget{index_constructor}{}\section{The problem constructor}\label{index_constructor}
The problem constructor is identical to that in the \href{../../two_d_unsteady_heat/html/index.html}{\tt previous example.}



 

\hypertarget{index_destructor}{}\section{The problem destructor}\label{index_destructor}
The problem destructor is identical to that in the \href{../../two_d_unsteady_heat/html/index.html}{\tt previous example.}



 

\hypertarget{index_before_timestep}{}\section{Actions before timestep}\label{index_before_timestep}
This function is identical to that in the \href{../../two_d_unsteady_heat/html/index.html}{\tt previous example.}



 

\hypertarget{index_IC}{}\section{Set initial condition}\label{index_IC}
We start by checking the validity of the command line arguments, accessible via the namespace {\ttfamily Command\+Line\+Args}, as only a single command line argument is allowed. If a command line argument is provided, it is interpreted as the name of the restart file. We try to open the file and, if successful, pass the input stream to the {\ttfamily restart}(...) function, discussed below. If no command line arguments are specified, we generate the initial conditions, essentially as in the \href{../../two_d_unsteady_heat/html/index.html}{\tt previous example.} The only difference is that in the current version of the code, we moved the specification and initialisation of the timestep from the {\ttfamily main} function into {\ttfamily set\+\_\+initial\+\_\+condition()}. This is because in a restarted simulation, the value of {\ttfamily dt} must be consistent with that used in the original simulation. If the simulation is restarted, the generic {\ttfamily Problem\+::read}(...) function, called by {\ttfamily restart}(...), automatically initialises the previous timestep; otherwise we have to perform the initialisation ourselves.


\begin{DoxyCodeInclude}
\textcolor{comment}{//======================start\_of\_set\_initial\_condition====================}
\textcolor{comment}{/// \(\backslash\)short Set initial condition: Assign previous and current values}
\textcolor{comment}{}\textcolor{comment}{/// from exact solution or from restart file.}
\textcolor{comment}{}\textcolor{comment}{//========================================================================}
\textcolor{keyword}{template}<\textcolor{keyword}{class} ELEMENT>
\textcolor{keywordtype}{void} \hyperlink{classUnsteadyHeatProblem_a98de3ed2d9cf5409323121bbb482bc1b}{UnsteadyHeatProblem<ELEMENT>::set\_initial\_condition}
      ()
\{ 

 \textcolor{comment}{// Pointer to restart file}
 ifstream* restart\_file\_pt=0;

 \textcolor{comment}{// Restart?}
 \textcolor{comment}{//---------}
 \textcolor{comment}{// Restart file specified via command line [all programs have at least}
 \textcolor{comment}{// a single command line argument: their name. Ignore this here.]}
 \textcolor{keywordflow}{if} (CommandLineArgs::Argc==1)
  \{
   cout << \textcolor{stringliteral}{"No restart -- setting IC from exact solution"} << std::endl;
  \}
 \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (CommandLineArgs::Argc==2)
  \{
   \textcolor{comment}{// Open restart file}
   restart\_file\_pt= \textcolor{keyword}{new} ifstream(CommandLineArgs::Argv[1],ios\_base::in);
   \textcolor{keywordflow}{if} (restart\_file\_pt!=0)
    \{
     cout << \textcolor{stringliteral}{"Have opened "} << CommandLineArgs::Argv[1] << 
      \textcolor{stringliteral}{" for restart. "} << std::endl;
    \}
   \textcolor{keywordflow}{else}
    \{
     std::ostringstream error\_stream;
     error\_stream 
      << \textcolor{stringliteral}{"ERROR while trying to open "} << CommandLineArgs::Argv[1] << 
      \textcolor{stringliteral}{" for restart."} << std::endl;

     \textcolor{keywordflow}{throw} OomphLibError(
      error\_stream.str(),
      OOMPH\_CURRENT\_FUNCTION,
      OOMPH\_EXCEPTION\_LOCATION);
    \}
  \}
 \textcolor{comment}{// More than one command line argument?}
 \textcolor{keywordflow}{else} 
  \{
   std::ostringstream error\_stream;
   error\_stream << \textcolor{stringliteral}{"Can only specify one input file\(\backslash\)n"} 
                << \textcolor{stringliteral}{"You specified the following command line arguments:\(\backslash\)n"};
   \textcolor{comment}{//Fix this}
   CommandLineArgs::output();

   \textcolor{keywordflow}{throw} OomphLibError( 
    error\_stream.str(),
    OOMPH\_CURRENT\_FUNCTION,
    OOMPH\_EXCEPTION\_LOCATION);
  \}


 \textcolor{comment}{// Read restart data:}
 \textcolor{comment}{//-------------------}
 \textcolor{keywordflow}{if} (restart\_file\_pt!=0)
  \{

   \textcolor{comment}{// Read the problem data from the restart file}
   restart(*restart\_file\_pt);

  \}
 \textcolor{comment}{// Assign initial condition from exact solution}
 \textcolor{comment}{//---------------------------------------------}
 \textcolor{keywordflow}{else}
  \{
   
   \textcolor{comment}{// Choose timestep}
   \textcolor{keywordtype}{double} dt=0.01;
   
   \textcolor{comment}{// Initialise timestep -- also sets the weights for all timesteppers}
   \textcolor{comment}{// in the problem.}
   initialise\_dt(dt);
   
   \textcolor{comment}{// Backup time in global Time object}
   \textcolor{keywordtype}{double} backed\_up\_time=time\_pt()->time();
   
   \textcolor{comment}{// Past history fo needs to be established for t=time0-deltat, ...}
   \textcolor{comment}{// Then provide current values (at t=time0) which will also form}
   \textcolor{comment}{// the initial guess for the first solve at t=time0+deltat}
   
   \textcolor{comment}{// Vector of exact solution value}
   Vector<double> soln(1);
   Vector<double> x(2);
   
   \textcolor{comment}{//Find number of nodes in mesh}
   \textcolor{keywordtype}{unsigned} num\_nod = mesh\_pt()->nnode();
   
   \textcolor{comment}{// Set continuous times at previous timesteps}
   \textcolor{keywordtype}{int} nprev\_steps=time\_stepper\_pt()->nprev\_values();
   Vector<double> prev\_time(nprev\_steps+1);
   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} itime=nprev\_steps;itime>=0;itime--)
    \{
     prev\_time[itime]=time\_pt()->time(\textcolor{keywordtype}{unsigned}(itime));
    \} 
   
   \textcolor{comment}{// Loop over current & previous timesteps}
   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} itime=nprev\_steps;itime>=0;itime--)
    \{
     \textcolor{comment}{// Continuous time}
     \textcolor{keywordtype}{double} time=prev\_time[itime];
     cout << \textcolor{stringliteral}{"setting IC at time ="} << time << std::endl;
     
     \textcolor{comment}{// Loop over the nodes to set initial guess everywhere}
     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} n=0;n<num\_nod;n++)
      \{
       \textcolor{comment}{// Get nodal coordinates}
       x[0]=mesh\_pt()->node\_pt(n)->x(0);
       x[1]=mesh\_pt()->node\_pt(n)->x(1);
       
       \textcolor{comment}{// Get intial solution}
       \hyperlink{namespaceExactSolnForUnsteadyHeat_a1d5b22857bd2a7825397daf1cf9c89eb}{ExactSolnForUnsteadyHeat::get\_exact\_u}(time,x,soln);
       
       \textcolor{comment}{// Assign solution}
       mesh\_pt()->node\_pt(n)->set\_value(itime,0,soln[0]);
       
       \textcolor{comment}{// Loop over coordinate directions: Previous position = present position}
       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} i=0;i<2;i++)
        \{
         mesh\_pt()->node\_pt(n)->x(itime,i)=x[i];
        \}
      \} 
    \}
   
   \textcolor{comment}{// Reset backed up time for global timestepper}
   time\_pt()->time()=backed\_up\_time;

  \}


\} \textcolor{comment}{// end of set\_initial\_condition}

\end{DoxyCodeInclude}




 

\hypertarget{index_doc}{}\section{Post-\/processing}\label{index_doc}
The Problem member function {\ttfamily doc\+\_\+solution}(...) is identical to that in the \href{../../two_d_unsteady_heat/html/index.html}{\tt previous example,} apart from the addition of a call to the new {\ttfamily dump\+\_\+it}(...) function, discussed below.


\begin{DoxyCodeInclude}
 \textcolor{comment}{// Write restart file}
 sprintf(filename,\textcolor{stringliteral}{"%s/restart%i.dat"},doc\_info.directory().c\_str(),
         doc\_info.number());
 some\_file.open(filename);
 dump\_it(some\_file);
 some\_file.close();

\end{DoxyCodeInclude}




 

\hypertarget{index_dump}{}\section{Dumping the solution}\label{index_dump}
The {\ttfamily Problem\+::dump}(...) function writes the generic {\ttfamily Problem} data in A\+S\+C\+II format to the specified output file. The content of the file can therefore be inspected and, if necessary, manipulated before a restart. However, the specific content of the file is generally of little interest -- it is written in a format that can be read by the corresponding function {\ttfamily Problem\+::read}(...).

Briefly, the dump file contains\+:
\begin{DoxyItemize}
\item A flag that indicates if the data was produced by a time-\/dependent simulation.
\item The current value of the \char`\"{}continuous\char`\"{} time, i.\+e. the value returned by {\ttfamily Problem\+::time\+\_\+pt()-\/$>$time()};
\item The number of previous timesteps, {\ttfamily dt}, stored in the {\ttfamily Problem\textquotesingle{}s} {\ttfamily Time} object, and their values.
\item The values and history values for all {\ttfamily Data} objects in the {\ttfamily Problem}, as well as the present and previous coordinates of all {\ttfamily Nodes}.
\end{DoxyItemize}The \char`\"{}raw data\char`\"{} is augmented by brief comments that facilitate the identification of individual entries.

In the present problem, the generic {\ttfamily Problem\+::dump}(...) function is sufficient to record the current state of the simulation, therefore no additional information needs to be added to the dump file. The section \hyperlink{index_comments}{Comments and Exercises} below contains an exercise that illustrates how to customise the dump function to record additional parameters; the \href{../../two_d_unsteady_heat_ALE/html/index.html}{\tt demo code with spatial adaptivity} provides another example of a customised dump/restart function.


\begin{DoxyCodeInclude}
\textcolor{comment}{//=====start\_of\_dump\_it===================================================}
\textcolor{comment}{/// Dump the solution to disk to allow for restart}
\textcolor{comment}{}\textcolor{comment}{//========================================================================}
\textcolor{keyword}{template}<\textcolor{keyword}{class} ELEMENT>
\textcolor{keywordtype}{void} \hyperlink{classUnsteadyHeatProblem_a9a60874a6471414819301705f1a2afd1}{UnsteadyHeatProblem<ELEMENT>::dump\_it}(ofstream& dump\_file)
\{

 \textcolor{comment}{// Call generic dump()}
 Problem::dump(dump\_file); 

\} \textcolor{comment}{// end of dump\_it}

\end{DoxyCodeInclude}




 

\hypertarget{index_read}{}\section{Reading a solution from disk}\label{index_read}
Since the restart file was written by the generic {\ttfamily Problem\+::dump}(...) function, it can be read back with the generic {\ttfamily Problem\+::read}(...) function. If any additional data had been recorded in the restart file, additional read statements could be added here; see \hyperlink{index_comments}{Comments and Exercises}.


\begin{DoxyCodeInclude}
\textcolor{comment}{//=================start\_of\_restart=======================================}
\textcolor{comment}{/// Read solution from disk for restart}
\textcolor{comment}{}\textcolor{comment}{//========================================================================}
\textcolor{keyword}{template}<\textcolor{keyword}{class} ELEMENT>
\textcolor{keywordtype}{void} \hyperlink{classUnsteadyHeatProblem_ad0a4a1c1da24f6d62f64b0d40be31709}{UnsteadyHeatProblem<ELEMENT>::restart}(ifstream& restart\_file)
\{

 \textcolor{comment}{// Read the generic problem data from restart file}
 Problem::read(restart\_file);

\} \textcolor{comment}{// end of restart}

\end{DoxyCodeInclude}




 

\hypertarget{index_comments}{}\section{Comments and Exercises}\label{index_comments}
The {\ttfamily Problem\+::dump}(...) and {\ttfamily Problem\+::read}(...) functions write/read the generic data that is common to all {\ttfamily oomph-\/lib} problems. Occasionally, it is necessary to record additional data to re-\/create the system\textquotesingle{}s state when the simulations is restarted. We will explore this in more detail in \href{../../two_d_unsteady_heat_2adapt/html/index.html}{\tt another example}. Here we provide a brief exercise that illustrates the general idea and addresses a shortcoming of the driver code\+: Currently the program computes the same number of timesteps, regardless of whether or not the simulation was restarted. If a simulation is restarted, the computation therefore continues past $ t=t_{max}. $\hypertarget{index_exercises}{}\subsection{Exercises}\label{index_exercises}

\begin{DoxyItemize}
\item Change the {\ttfamily for} loop over the fixed number of timesteps in the {\ttfamily main} function to a {\ttfamily while} loop that checks if the continuous time, accessible via {\ttfamily Problem\+::time\+\_\+pt()-\/$>$time()}, has reached or exceeded $ t_{max} $. This works because the {\ttfamily Problem\+::dump}(...) and {\ttfamily Problem\+::read}(...) functions dump and restore the value of the continuous time.
\item Following this trivial change, the restarted simulation is terminated at the appropriate point but the numbering of the output files begins at 0, making it difficult to merge the results from the original and the restarted simulations. Modify the functions {\ttfamily dump\+\_\+it}(...) and {\ttfamily restart}(...) so that they write/read the current label for the output files to/from the restart file. ~\newline
~\newline
 {\bfseries Hints\+:} {\bfseries (i)} You can write to/read from the restart file before calling {\ttfamily Problem\+::dump}(...) and {\ttfamily Problem\+::read}(...); just make sure you do it in the same order in both functions. {\bfseries (ii)} The easiest way to make the label, currently stored in the {\ttfamily Doc\+Info} object in the {\ttfamily main} function, accessible to all member functions in the {\ttfamily Problem} is to make the {\ttfamily Doc\+Info} object a private data member of the {\ttfamily Problem} class.
\end{DoxyItemize}



 

\hypertarget{index_sources}{}\section{Source files for this tutorial}\label{index_sources}

\begin{DoxyItemize}
\item The source files for this tutorial are located in the directory\+: \begin{center} \href{../../../../demo_drivers/unsteady_heat/two_d_unsteady_heat/}{\tt demo\+\_\+drivers/unsteady\+\_\+heat/two\+\_\+d\+\_\+unsteady\+\_\+heat/ } \end{center} 
\item The driver code is\+: \begin{center} \href{../../../../demo_drivers/unsteady_heat/two_d_unsteady_heat/two_d_unsteady_heat_restarted.cc}{\tt demo\+\_\+drivers/unsteady\+\_\+heat/two\+\_\+d\+\_\+unsteady\+\_\+heat/two\+\_\+d\+\_\+unsteady\+\_\+heat\+\_\+restarted.\+cc } \end{center} 
\end{DoxyItemize}



 

 \hypertarget{index_pdf}{}\section{P\+D\+F file}\label{index_pdf}
A \href{../latex/refman.pdf}{\tt pdf version} of this document is available. \end{document}
